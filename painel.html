<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SlotlyCare - Professional Setup</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary-bg: #F8FAFC;
    --card-bg: #FFFFFF;
    --text-main: #1E293B;
    --text-muted: #64748B;
    --accent-blue: #0EA5E9;
    --border-color: #E2E8F0;
    --input-bg: #FFFFFF;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--primary-bg);
    color: var(--text-main);
    min-height: 100vh;
    padding: 40px 20px;
    line-height: 1.5;
}

/* Auth overlay */
.auth-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-bg);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.auth-overlay.hidden {
    display: none;
}

.auth-message {
    text-align: center;
}

.auth-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #E2E8F0;
    border-radius: 50%;
    border-top-color: var(--accent-blue);
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.top-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
}

.top-bar-logo {
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--text-main);
}

.top-bar-logo span {
    color: var(--accent-blue);
}

.top-bar-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.btn-dashboard {
    background: #10B981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
}

.btn-dashboard:hover {
    background: #059669;
}

.btn-logout {
    background: #EF4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
}

.btn-logout:hover {
    background: #DC2626;
}

.btn-change-password {
    background: #8B5CF6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
}

.btn-change-password:hover {
    background: #7C3AED;
}

.language-selector {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 999;
}

.language-selector select {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-main);
    box-shadow: var(--shadow-sm);
    outline: none;
    transition: border-color 0.2s;
}

.language-selector select:hover {
    border-color: var(--accent-blue);
}

h1 {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 40px;
    color: var(--text-main);
    text-align: center;
    letter-spacing: -0.025em;
}

h1 span {
    color: var(--accent-blue);
}

.main-wrapper {
    display: flex;
    gap: 40px;
    max-width: 1200px;
    margin: 0 auto;
    align-items: flex-start;
}

.container {
    flex: 1;
    background: var(--card-bg);
    padding: 32px;
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.preview-section {
    flex-shrink: 0;
    width: 420px;
    position: sticky;
    top: 40px;
}

.preview-label {
    text-align: center;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.preview {
    width: 100%;
    min-height: 620px;
    height: auto;
    border-radius: 24px;
    background: white;
    box-shadow: var(--shadow-lg);
    border: 8px solid #1E293B;
    overflow: visible;
    position: relative;
}

.preview-header {
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
    color: white;
    padding: 40px 24px;
    text-align: center;
    transition: background 0.4s ease;
}

.preview-logo {
    width: 80px;
    height: 80px;
    max-width: 80px;
    max-height: 80px;
    border-radius: 50%;
    margin: 0 auto 16px auto;
    border: 3px solid white;
    background: white;
    display: none;
    object-fit: cover;
}

.preview-logo.active {
    display: block;
}

.preview-doctor-name {
    font-size: 22px;
    margin-bottom: 4px;
    font-weight: 700;
}

.preview-specialty {
    opacity: 0.9;
    font-size: 14px;
    font-weight: 500;
    display: none;
}

.preview-specialty.active {
    display: block;
}

.preview-quote {
    background: rgba(255,255,255,0.15);
    padding: 12px;
    border-radius: 10px;
    margin-top: 16px;
    font-style: italic;
    font-size: 13px;
    display: none;
    backdrop-filter: blur(4px);
}

.preview-quote.active {
    display: block;
}

.preview-content {
    padding: 24px;
    background: white;
}

.preview-calendar-title {
    color: var(--text-main);
    margin-bottom: 16px;
    font-size: 16px;
    font-weight: 700;
    text-align: center;
}

.preview-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    margin-bottom: 24px;
}

.preview-day {
    aspect-ratio: 1;
    border: 1px solid #F1F5F9;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #64748B;
    background: #F8FAFC;
}

.preview-day.selected {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
    font-weight: 600;
}

.preview-button {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    font-weight: 600;
    color: white;
    text-align: center;
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
    font-size: 15px;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}

.preview-info-box {
    background: #F8FAFC;
    padding: 20px;
    border-radius: 12px;
    margin-top: 24px;
    text-align: center;
    border: 1px solid #F1F5F9;
}

.preview-info-item {
    margin-bottom: 12px;
    font-size: 13px;
    color: var(--text-muted);
}

.preview-info-item strong {
    color: var(--text-main);
    display: block;
    margin-bottom: 2px;
}

.trial-banner {
    display: none;
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border: 1px solid #F59E0B;
    border-radius: 12px;
    padding: 16px 24px;
    margin-bottom: 24px;
    text-align: center;
}

.trial-banner.expired {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    border-color: #EF4444;
}

.trial-banner h3 {
    margin: 0 0 8px 0;
    font-size: 1rem;
    color: #92400E;
}

.trial-banner.expired h3 {
    color: #991B1B;
}

.trial-banner p {
    margin: 0 0 12px 0;
    font-size: 0.9rem;
    color: #78350F;
}

.trial-banner.expired p {
    color: #7F1D1D;
}

.trial-banner .btn-subscribe {
    display: inline-block;
    background: #F59E0B;
    color: white;
    padding: 8px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
}

.trial-banner.expired .btn-subscribe {
    background: #EF4444;
}

.preview-expired-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.92);
    z-index: 10;
    border-radius: 16px;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
}

.preview-expired-overlay .expired-icon {
    font-size: 3rem;
    margin-bottom: 16px;
}

.preview-expired-overlay h3 {
    font-size: 1.2rem;
    color: #1A1A1A;
    margin-bottom: 8px;
}

.preview-expired-overlay p {
    color: #6B6B6B;
    font-size: 0.9rem;
    margin-bottom: 20px;
}

.preview-expired-overlay .btn-subscribe {
    background: #0D9488;
    color: white;
    padding: 10px 28px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
}

.control-group {
    margin-bottom: 24px;
}

.control-group label {
    font-weight: 700;
    color: var(--text-main);
    display: block;
    margin-bottom: 8px;
    font-size: 1rem;
}

.control-group label span {
    color: var(--text-muted);
    font-weight: 700;
    font-size: 0.8rem;
}

input[type="text"],
input[type="email"],
input[type="tel"],
textarea {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 12px 16px;
    border-radius: 10px;
    width: 100%;
    font-size: 0.95rem;
    transition: all 0.2s;
    font-family: inherit;
}

input:focus,
textarea:focus {
    border-color: var(--accent-blue);
    outline: none;
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
}

textarea {
    min-height: 80px;
    resize: vertical;
}

.color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 8px;
}

.color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s;
    position: relative;
}

.color-swatch.active {
    border-color: var(--text-main);
    transform: scale(1.1);
}

.color-swatch:hover {
    transform: scale(1.1);
}

.btn-main {
    background: var(--text-main);
    color: #ffffff;
    border: none;
    padding: 16px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
}

.btn-main:hover:not(:disabled) {
    background: #000000;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: white;
    color: var(--text-main);
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    width: 100%;
    margin-bottom: 12px;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: var(--primary-bg);
    border-color: var(--text-muted);
}

.btn-danger {
    background: #FEF2F2;
    color: #EF4444;
    border: 1px solid #FEE2E2;
    padding: 8px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
}

.message {
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
}

.ai-intro-box {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    border: 1px solid #BFDBFE;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}

.ai-intro-text {
    font-size: 0.95rem;
    color: #1E40AF;
    font-weight: 500;
    margin-bottom: 12px;
    line-height: 1.5;
}

.ai-examples {
    margin-top: 12px;
}

.ai-examples strong {
    font-size: 0.9rem;
    color: #1E40AF;
    display: block;
    margin-bottom: 8px;
}

.ai-examples ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.ai-example-item {
    background: white;
    padding: 10px 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #475569;
    border: 1px solid #E0E7FF;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    transition: all 0.2s;
}

.ai-example-item:hover {
    background: #F8FAFC;
    border-color: #93C5FD;
    transform: translateX(2px);
}

.ai-example-item:last-child {
    margin-bottom: 0;
}

.btn-try-example {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.btn-try-example:hover {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
}

.btn-try-example:active {
    transform: translateY(0);
}

.message {
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
}

.message.success {
    background: #F0FDF4;
    border: 1px solid #DCFCE7;
    color: #166534;
}

/* Modal de confirma√ß√£o */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.modal-icon {
    font-size: 2rem;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-main);
}

.modal-body {
    margin-bottom: 24px;
    color: var(--text-muted);
    line-height: 1.6;
}

.modal-link-change {
    background: #F8FAFC;
    padding: 12px;
    border-radius: 8px;
    margin: 16px 0;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.modal-link-old {
    color: #EF4444;
    text-decoration: line-through;
}

.modal-link-new {
    color: #10B981;
    font-weight: 600;
}

.modal-checklist {
    background: #FEF2F2;
    border: 1px solid #FEE2E2;
    border-radius: 8px;
    padding: 12px 16px;
    margin: 16px 0;
}

.modal-checklist-title {
    font-weight: 600;
    color: #991B1B;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.modal-checklist ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.modal-checklist li {
    color: #7F1D1D;
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.modal-checklist li:before {
    content: "‚úì ";
    margin-right: 6px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.modal-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-size: 0.95rem;
    transition: all 0.2s;
}

.modal-btn-cancel {
    background: white;
    border: 1px solid var(--border-color);
    color: var(--text-main);
}

.modal-btn-cancel:hover {
    background: var(--primary-bg);
}

.modal-btn-confirm {
    background: #EF4444;
    color: white;
}

.modal-btn-confirm:hover {
    background: #DC2626;
}

.link-section {
    margin-top: 32px;
    padding-top: 32px;
    border-top: 1px solid var(--border-color);
}

.link-section label {
    font-weight: 700;
    color: var(--text-main);
    display: block;
    margin-bottom: 8px;
    font-size: 1rem;
}

.link-section label span {
    font-weight: 700;
}

.link-box {
    background: #F8FAFC;
    padding: 16px;
    border-radius: 12px;
    margin-top: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-color);
}

.link-box code {
    color: var(--accent-blue);
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.btn-copy {
    padding: 6px 12px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-main);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.8rem;
    margin-left: 12px;
}

.btn-copy:hover {
    background: var(--primary-bg);
}

.spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #ffffff;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 1000px) {
    .main-wrapper {
        flex-direction: column;
        align-items: center;
    }
    .preview-section {
        position: static;
        width: 100%;
        max-width: 420px;
    }
}
</style>
</head>
<body>

<!-- Auth overlay - shown while checking login -->
<div class="auth-overlay" id="authOverlay">
    <div class="auth-message">
        <div class="auth-spinner"></div>
        <p>Verifying access...</p>
    </div>
</div>

<!-- Top bar with logo and actions -->
<div class="top-bar">
    <div class="top-bar-logo">Slotly<span>Care</span></div>
    <div class="top-bar-actions">
        <a href="dashboard.html" class="btn-dashboard">üìä Dashboard</a>
        <button class="btn-change-password" onclick="openChangePasswordModal()">üîë Password</button>
        <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
</div>

<div class="language-selector">
    <select id="languageSelector">
        <option value="en">English</option>
        <option value="pt">Portugu√™s</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
    </select>
</div>

<h1 id="mainTitle" data-i18n="title" style="margin-top: 60px;">SlotlyCare Setup</h1>

<div id="trialBanner" class="trial-banner" style="display: none; max-width: 900px; margin: 0 auto 24px;">
    <h3 id="trialBannerTitle">‚è≥ Free Trial ‚Äî <span id="trialDaysText">7 days remaining</span></h3>
    <p id="trialBannerMsg">Your booking link and slot generation are active during the trial period.</p>
    <a href="subscribe.html" class="btn-subscribe" id="trialBannerBtn">Subscribe Now</a>
</div>

<div class="main-wrapper">
    <div class="container">
        <!-- Logo -->
        <div class="control-group">
            <label>üì∏ <span data-i18n="logo_label">Logo</span> <span data-i18n="optional_text">(optional)</span></label>
            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
            <button onclick="document.getElementById('logoUpload').click()" class="btn-secondary" id="btnUploadLogo" data-i18n="upload_logo">Choose</button>
            <button onclick="removeLogo()" class="btn-danger" id="btnRemoveLogo" style="display: none;" data-i18n="remove_logo">Remove</button>
        </div>

        <!-- Cor -->
        <div class="control-group">
            <label>üé® <span data-i18n="colors_label">Color</span></label>
            <div class="color-palette">
                <div class="color-swatch active" style="background: #2563eb" data-color="#2563eb" data-secondary="#10b981"></div>
                <div class="color-swatch" style="background: #8b5cf6" data-color="#8b5cf6" data-secondary="#ec4899"></div>
                <div class="color-swatch" style="background: #10b981" data-color="#10b981" data-secondary="#3b82f6"></div>
                <div class="color-swatch" style="background: #ef4444" data-color="#ef4444" data-secondary="#f97316"></div>
                <div class="color-swatch" style="background: #f59e0b" data-color="#f59e0b" data-secondary="#eab308"></div>
                <div class="color-swatch" style="background: #06b6d4" data-color="#06b6d4" data-secondary="#0ea5e9"></div>
                <div class="color-swatch" style="background: #ec4899" data-color="#ec4899" data-secondary="#f43f5e"></div>
                <div class="color-swatch" style="background: #1abc9c" data-color="#1abc9c" data-secondary="#16a085"></div>
                <div class="color-swatch" style="background: #334155" data-color="#334155" data-secondary="#475569"></div>
            </div>
        </div>

        <!-- Nome -->
        <div class="control-group">
            <label>üë®‚Äç‚öïÔ∏è <span data-i18n="name_text">Name</span></label>
            <input type="text" id="doctorName" placeholder="" value="Dr. John">
        </div>

        <!-- Especialidade -->
        <div class="control-group">
            <label>üíä <span data-i18n="specialty_text">Specialty</span> <span data-i18n="optional_text">(optional)</span></label>
            <input type="text" id="specialty" placeholder="">
        </div>

        <!-- Endere√ßo -->
        <div class="control-group">
            <label>üìç <span data-i18n="address_label">Address</span></label>
            <textarea id="address" placeholder=""></textarea>
        </div>

        <!-- Telefone -->
        <div class="control-group">
            <label>üìû <span data-i18n="phone_label">Phone</span></label>
            <input type="tel" id="phone" placeholder="">
        </div>

        <!-- Email -->
        <div class="control-group">
            <label>‚úâÔ∏è <span data-i18n="email_label">Email</span></label>
            <input type="email" id="email" placeholder="">
        </div>

        <!-- Mensagem -->
        <div class="control-group">
            <label>üí¨ <span data-i18n="message_text">Message</span> <span data-i18n="optional_text">(optional)</span></label>
            <input type="text" id="welcomeMsg" placeholder="">
        </div>

        <!-- Informa√ß√µes Adicionais -->
        <div class="control-group">
            <label>‚ÑπÔ∏è <span data-i18n="additional_info_label">Additional information</span> <span data-i18n="optional_text">(optional)</span></label>
            <textarea id="additionalInfo" placeholder="" rows="3"></textarea>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;" data-i18n="additional_info_hint">E.g.: accepted insurance, consultation fee, cancellation policy</p>
        </div>

        <!-- Hor√°rios -->
        <div class="control-group">
            <label>ü§ñ <span data-i18n="schedule_label">AI Schedule Configuration</span></label>
            
            <div class="ai-intro-box">
                <p class="ai-intro-text" data-i18n="ai_intro"></p>
                <div class="ai-examples">
                    <strong data-i18n="ai_examples_title"></strong>
                    <ul>
                        <li class="ai-example-item" data-example-en="Monday to Friday 9am-5pm. Saturday 8am-12pm. 30-minute appointments" data-example-pt="Segunda a sexta 9h-17h. S√°bado 8h-12h. Consultas de 30 minutos" data-example-es="Lunes a viernes 9h-17h. S√°bado 8h-12h. Consultas de 30 minutos" data-example-fr="Lundi √† vendredi 9h-17h. Samedi 8h-12h. Consultations de 30 minutes" data-example-de="Montag bis Freitag 9-17 Uhr. Samstag 8-12 Uhr. 30-min√ºtige Termine" data-example-it="Luned√¨ a venerd√¨ 9-17. Sabato 8-12. Appuntamenti di 30 minuti">
                            <span data-i18n="ai_example_1"></span>
                        </li>
                        <li class="ai-example-item" data-example-en="Monday to Friday 8am-6pm, lunch 12pm-1pm. 30-minute appointments" data-example-pt="Segunda a sexta 8h-18h, almo√ßo 12h-13h. Consultas de 30 minutos" data-example-es="Lunes a viernes 8h-18h, almuerzo 12h-13h. Consultas de 30 minutos" data-example-fr="Lundi √† vendredi 8h-18h, d√©jeuner 12h-13h. Consultations de 30 minutes" data-example-de="Montag bis Freitag 8-18 Uhr, Mittagspause 12-13 Uhr. 30-min√ºtige Termine" data-example-it="Luned√¨ a venerd√¨ 8-18, pranzo 12-13. Appuntamenti di 30 minuti">
                            <span data-i18n="ai_example_2"></span>
                        </li>
                        <li class="ai-example-item" data-example-en="Monday, Wednesday and Friday 8am-6pm. Tuesday and Thursday 2pm-8pm. 40-minute appointments" data-example-pt="Segunda, quarta e sexta 8h-18h. Ter√ßa e quinta 14h-20h. Consultas de 40 minutos" data-example-es="Lunes, mi√©rcoles y viernes 8h-18h. Martes y jueves 14h-20h. Consultas de 40 minutos" data-example-fr="Lundi, mercredi et vendredi 8h-18h. Mardi et jeudi 14h-20h. Consultations de 40 minutes" data-example-de="Montag, Mittwoch und Freitag 8-18 Uhr. Dienstag und Donnerstag 14-20 Uhr. 40-min√ºtige Termine" data-example-it="Luned√¨, mercoled√¨ e venerd√¨ 8-18. Marted√¨ e gioved√¨ 14-20. Appuntamenti di 40 minuti">
                            <span data-i18n="ai_example_3"></span>
                        </li>
                        <li class="ai-example-item" data-example-en="Monday to Friday 9am-6pm, 45-minute appointments. Block December 20 to January 5 for vacation" data-example-pt="Segunda a sexta 9h-18h, consultas de 45 minutos. Bloquear 20 de dezembro a 5 de janeiro para f√©rias" data-example-es="Lunes a viernes 9h-18h, consultas de 45 minutos. Bloquear 20 de diciembre a 5 de enero por vacaciones" data-example-fr="Lundi √† vendredi 9h-18h, consultations de 45 minutes. Bloquer du 20 d√©cembre au 5 janvier pour vacances" data-example-de="Montag bis Freitag 9-18 Uhr, 45-min√ºtige Termine. 20. Dezember bis 5. Januar f√ºr Urlaub blockieren" data-example-it="Luned√¨ a venerd√¨ 9-18, appuntamenti di 45 minuti. Bloccare dal 20 dicembre al 5 gennaio per ferie">
                            <span data-i18n="ai_example_4"></span>
                        </li>
                        <li class="ai-example-item" data-example-en="Tuesday to Saturday 10am-7pm, but Wednesdays only until 3pm. 1-hour appointments" data-example-pt="Ter√ßa a s√°bado 10h-19h, mas quartas s√≥ at√© 15h. Consultas de 1 hora" data-example-es="Martes a s√°bado 10h-19h, pero mi√©rcoles solo hasta 15h. Consultas de 1 hora" data-example-fr="Mardi √† samedi 10h-19h, mais mercredi seulement jusqu'√† 15h. Consultations de 1 heure" data-example-de="Dienstag bis Samstag 10-19 Uhr, aber Mittwoch nur bis 15 Uhr. 1-st√ºndige Termine" data-example-it="Marted√¨ a sabato 10-19, ma mercoled√¨ solo fino alle 15. Appuntamenti di 1 ora">
                            <span data-i18n="ai_example_5"></span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <textarea id="scheduleInput" placeholder=""></textarea>
            <button onclick="processSchedule()" id="btnProcessSchedule" class="btn-secondary" style="margin-top: 8px;" data-i18n="generate_schedule">Generate Slots</button>
        </div>

        <!-- Link Personalizado -->
        <div class="control-group">
            <label>üîó Your Custom Link</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="color: var(--text-muted); font-size: 0.9rem; white-space: nowrap;">https://slotlycare.com/</span>
                <input type="text" id="customLink" placeholder="my-clinic" style="flex: 1;" maxlength="50">
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; line-height: 1.4;">
                üí° <strong>Choose carefully!</strong> Only letters, numbers and hyphens.<br>
                Examples: <code>dr-john-smith</code>, <code>heart-clinic</code>, <code>downtown-medical</code><br>
                ‚ö†Ô∏è You can change it later, but the old link will stop working.
            </p>
            <div id="linkAvailability" style="font-size: 0.8rem; margin-top: 8px; display: none;"></div>
        </div>

        <button onclick="saveConfiguration()" id="btnSave" class="btn-main" data-i18n="save_config">Save & Generate Link</button>

        <div id="successMessage" class="message" style="display: none;"></div>

        <div class="link-section">
            <label>üîó <span data-i18n="link_label">Your Personal Booking Link</span></label>
            <div class="link-box">
                <code id="bookingLink" data-i18n="link_placeholder">Save to generate link</code>
                <button class="btn-copy" onclick="copyLink()" data-i18n="copy_btn">Copy</button>
            </div>

        </div>

        <!-- Referral Section -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            
            <!-- Referral Stats Panel -->
            <div id="referralStatsPanel" style="display: none; background: linear-gradient(135deg, #F0FDF4, #DCFCE7); border: 1px solid #BBF7D0; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 1.1rem;">üìä</span>
                    <span style="font-weight: 600; color: #166534; font-size: 0.95rem;" data-i18n="referral_stats_title">Your Referrals</span>
                </div>
                <div id="referralStatsContent" style="font-size: 0.88rem; color: #15803D; line-height: 1.6;">
                    <!-- Filled by JS -->
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #16A34A; font-style: italic;" data-i18n="referral_stats_thanks">SlotlyCare thanks you for your trust. üíö</div>
            </div>

            <!-- Personal Referral Link Preview -->
            <div id="referralLinkPreview" style="display: none; background: linear-gradient(135deg, #EFF6FF, #DBEAFE); border: 1px solid #93C5FD; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px; text-align: center;">
                <div style="font-size: 0.85rem; color: #1E40AF; margin-bottom: 8px; font-weight: 600;" data-i18n="referral_your_link">üîó Your personal referral link:</div>
                <div style="background: white; border: 1px solid #BFDBFE; border-radius: 8px; padding: 10px 14px; font-family: monospace; font-size: 0.82rem; color: #2563EB; word-break: break-all;">
                    slotlycare.com/convite/<span id="referralLinkPreviewSlug" style="font-weight: 700;"></span>/<span style="color: #93C5FD;">___</span>
                </div>
                <div style="font-size: 0.78rem; color: #3B82F6; margin-top: 8px;" data-i18n="referral_link_explain">Refer colleagues and they'll receive a personalized page with your recommendation.</div>
            </div>

            <div style="text-align: center;">
                <button onclick="openReferralModal()" id="btnReferral" style="
                    background: linear-gradient(135deg, #10B981, #059669);
                    color: white;
                    border: none;
                    padding: 12px 28px;
                    border-radius: 10px;
                    font-size: 0.95rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.3)'"
                data-i18n="referral_button">üë• Refer Colleagues</button>
            </div>
        </div>
    </div>

    <div class="preview-section">
        <div class="preview-label" data-i18n="preview_label">Live Preview</div>
        <div class="preview">
            <div class="preview-expired-overlay" id="previewExpiredOverlay">
                <div class="expired-icon">‚è∏Ô∏è</div>
                <h3>Your link is inactive</h3>
                <p>Your free trial has ended. Subscribe to reactivate your booking page.</p>
                <a href="subscribe.html" class="btn-subscribe">Subscribe Now ‚Üí</a>
            </div>
            <div class="preview-header" id="previewHeader">
                <img class="preview-logo" id="previewLogo" src="" alt="Logo">
                <div class="preview-doctor-name" id="previewDoctorName">Dr. John</div>
                <div class="preview-specialty" id="previewSpecialty">Cardiologist</div>
                <div class="preview-quote" id="previewQuote"></div>
            </div>
            <div class="preview-content">
                <div class="preview-calendar-title" data-i18n="preview_select_date">Select Appointment Date</div>
                <div class="preview-calendar">
                    <div class="preview-day">S</div>
                    <div class="preview-day">M</div>
                    <div class="preview-day">T</div>
                    <div class="preview-day">W</div>
                    <div class="preview-day">T</div>
                    <div class="preview-day">F</div>
                    <div class="preview-day">S</div>
                    <div class="preview-day" style="opacity: 0.3;">28</div>
                    <div class="preview-day" style="opacity: 0.3;">29</div>
                    <div class="preview-day" style="opacity: 0.3;">30</div>
                    <div class="preview-day">1</div>
                    <div class="preview-day">2</div>
                    <div class="preview-day">3</div>
                    <div class="preview-day">4</div>
                    <div class="preview-day">5</div>
                    <div class="preview-day">6</div>
                    <div class="preview-day">7</div>
                    <div class="preview-day">8</div>
                    <div class="preview-day">9</div>
                    <div class="preview-day selected">10</div>
                    <div class="preview-day">11</div>
                </div>
                <div class="preview-button" id="previewButton" data-i18n="preview_continue">Book Appointment</div>
                
                <div class="preview-info-box">
                    <div class="preview-info-item">
                        <strong data-i18n="preview_address">Location</strong>
                        <span id="previewAddress">123 Medical Center, Suite 100</span>
                    </div>
                    <div class="preview-info-item">
                        <strong data-i18n="preview_phone">Contact</strong>
                        <span id="previewPhone">+1 (555) 000-0000</span>
                    </div>
                    <div class="preview-info-item">
                        <strong data-i18n="preview_email_label">Email</strong>
                        <span id="previewEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f1929e9f85909285b1829d9e859d889c9495df929e9c">[email&#160;protected]</a></span>
                    </div>
                    <div class="preview-info-item" id="previewAdditionalInfoContainer" style="display: none;">
                        <strong>‚ÑπÔ∏è <span data-i18n="additional_info_label">Additional information</span></strong>
                        <span id="previewAdditionalInfo"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Mudan√ßa de Link -->
<div id="linkChangeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-icon">‚ö†Ô∏è</span>
            <h3 class="modal-title">Change Your Link?</h3>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 12px;">You are about to change your booking link:</p>
            
            <div class="modal-link-change">
                <div class="modal-link-old" id="modalOldLink">Old: https://slotlycare.com/old-link</div>
                <div class="modal-link-new" id="modalNewLink">New: https://slotlycare.com/new-link</div>
            </div>

            <p style="font-weight: 600; color: #DC2626; margin-bottom: 12px;">‚ö†Ô∏è Important:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                <li>Your old link will <strong>stop working immediately</strong></li>
                <li>Patients with the old link won't be able to book</li>
                <li>There is no automatic redirect</li>
            </ul>

            <div class="modal-checklist">
                <div class="modal-checklist-title">üìã Make sure to update:</div>
                <ul>
                    <li>Business cards</li>
                    <li>Website</li>
                    <li>Social media profiles</li>
                    <li>Email signatures</li>
                    <li>Advertisements</li>
                </ul>
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="cancelLinkChange()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmLinkChange()">Yes, Change Link</button>
        </div>
    </div>
</div>

<!-- Modal de Trocar Senha -->
<div id="changePasswordModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <span class="modal-icon">üîë</span>
            <h3 class="modal-title">Change Password</h3>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-main);">Current Password</label>
                <input type="password" id="currentPassword" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;" placeholder="Enter current password">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-main);">New Password</label>
                <input type="password" id="newPassword" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;" placeholder="Enter new password">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-main);">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem;" placeholder="Confirm new password">
            </div>
            <div id="passwordChangeMessage" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9rem;"></div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeChangePasswordModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" id="btnChangePassword" onclick="changePassword()" style="background: #8B5CF6;">Change Password</button>
        </div>
    </div>
</div>

<!-- Modal de Indica√ß√£o -->
<div id="referralModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 520px;">
        <div class="modal-header">
            <span class="modal-icon">üë•</span>
            <h3 class="modal-title" data-i18n="referral_title">Refer Colleagues</h3>
        </div>
        <div class="modal-body">
            <!-- FORM VIEW -->
            <div id="referralFormView">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;" data-i18n="referral_subtitle">Add colleagues who could benefit from SlotlyCare. Each one gets a personalized invite link.</p>
                
                <!-- Live Link Preview -->
                <div id="modalLinkPreview" style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; text-align: center;">
                    <div style="font-family: monospace; font-size: 0.82rem; color: #059669; word-break: break-all;">
                        slotlycare.com/convite/<span id="modalLinkDoctorSlug" style="font-weight: 700;"></span>/<span id="modalLinkInviteeSlug" style="font-weight: 700; color: #10B981;">___</span>
                    </div>
                </div>
                
                <div id="referralRows">
                    <!-- Dynamic rows inserted by JS -->
                </div>

                <!-- Email toggle -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding: 8px 12px; background: #F5F3FF; border: 1px solid #DDD6FE; border-radius: 8px;">
                    <input type="checkbox" id="referralEmailToggle" onchange="toggleEmailFields()" style="accent-color: #7C3AED; width: 16px; height: 16px; cursor: pointer;">
                    <label for="referralEmailToggle" style="font-size: 0.83rem; color: #5B21B6; cursor: pointer; line-height: 1.3;" data-i18n="referral_we_send_toggle">Want SlotlyCare to send the invitation for you?</label>
                </div>
                
                <button onclick="addReferralRow()" id="btnAddRow" style="
                    background: none; border: 1px dashed #BBF7D0; color: #10B981; padding: 8px 16px;
                    border-radius: 8px; font-size: 0.85rem; cursor: pointer; width: 100%; margin-bottom: 12px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.borderColor='#10B981';this.style.background='#F0FDF4'" onmouseout="this.style.borderColor='#BBF7D0';this.style.background='none'"
                data-i18n="referral_add_another">+ Add another colleague</button>

                <div id="referralStatusMessage" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.9rem;"></div>
            </div>

            <!-- LINKS RESULT VIEW -->
            <div id="referralLinksView" style="display: none;">
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
                    <div id="referralLinksTitle" style="font-weight: 600; font-size: 1.05rem; color: var(--text-main);">Invitations created!</div>
                </div>
                
                <div id="referralLinksList" style="
                    background: #F8FAFC; border: 1px solid var(--border-color); border-radius: 10px;
                    padding: 12px; margin-bottom: 16px; max-height: 300px; overflow-y: auto;
                ">
                    <!-- Links filled by JS -->
                </div>

                <button onclick="copyAllInviteLinks()" id="btnCopyAll" style="
                    background: linear-gradient(135deg, #10B981, #059669); color: white; border: none;
                    padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
                    cursor: pointer; width: 100%; margin-bottom: 8px; transition: all 0.2s ease;
                " data-i18n="referral_copy_all">üìã Copy All Links</button>

                <p style="color: var(--text-muted); font-size: 0.8rem; text-align: center; margin-bottom: 0;" data-i18n="referral_personalized_note">Each colleague will see a personalized page with your recommendation.</p>
            </div>
        </div>
        <div class="modal-actions">
            <!-- FORM BUTTONS -->
            <div id="referralFormButtons">
                <button class="modal-btn modal-btn-cancel" onclick="closeReferralModal()" data-i18n="referral_cancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="btnSendReferral" onclick="sendBatchReferrals()" style="background: #10B981;" data-i18n="referral_send">Send Invitations</button>
            </div>
            <!-- LINKS BUTTONS -->
            <div id="referralLinksButtons" style="display: none;">
                <button class="modal-btn modal-btn-cancel" onclick="resetReferralModal()" data-i18n="referral_another">Refer More</button>
                <button class="modal-btn modal-btn-confirm" onclick="closeReferralModal()" style="background: #10B981;" data-i18n="referral_close">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Referral List Modal -->
<div id="referralListModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 480px;">
        <div class="modal-header">
            <span class="modal-icon">üë•</span>
            <h3 class="modal-title" data-i18n="referral_list_title">Your Referrals</h3>
        </div>
        <div class="modal-body">
            <div id="referralListContent" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">...</div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-confirm" onclick="closeReferralListModal()" style="background: #10B981;" data-i18n="referral_close">Close</button>
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const translations = {
    en: {
        title: "SlotlyCare Setup",
        logo_label: "Logo",
        optional_text: "(optional)",
        upload_logo: "Choose",
        remove_logo: "Remove",
        name_text: "Name",
        specialty_text: "Specialty",
        message_text: "Message",
        additional_info_label: "Additional information",
        additional_info_hint: "E.g.: accepted insurance, consultation fee, cancellation policy",
        phone_label: "Phone",
        email_label: "Email",
        address_label: "Address",
        colors_label: "Color",
        schedule_label: "AI Schedule Configuration",
        ai_intro: "Talk to SlotlyCare AI and automate your medical schedule ‚Äî less manual work, fewer errors, more confirmed appointments",
        ai_examples_title: "üí° Examples:",
        ai_example_1: "Monday to Friday 9am-5pm. Saturday 8am-12pm. 30-minute appointments",
        ai_example_2: "Monday to Friday 8am-6pm, lunch 12pm-1pm. 30-minute appointments",
        ai_example_3: "Monday, Wednesday and Friday 8am-6pm. Tuesday and Thursday 2pm-8pm. 40-minute appointments",
        ai_example_4: "Monday to Friday 9am-6pm, 45-minute appointments. Block December 20 to January 5 for vacation",
        ai_example_5: "Tuesday to Saturday 10am-7pm, but Wednesdays only until 3pm. 1-hour appointments",
        generate_schedule: "Generate Slots",
        save_config: "Save & Generate Link",
        link_label: "Your Personal Booking Link",
        link_placeholder: "Save to generate link",
        copy_btn: "Copy",
        preview_label: "Live Preview",
        preview_select_date: "Select Appointment Date",
        preview_continue: "Book Appointment",
        preview_address: "Location",
        preview_phone: "Contact",
        preview_email_label: "Email",
        success_message: "‚úÖ Configuration saved successfully!",
        schedule_processed: "‚úÖ Schedule processed!",
        copied: "Copied!",
        referral_button: "üë• Refer Colleagues",
        referral_title: "Refer Colleagues",
        referral_subtitle: "Add colleagues who could benefit from SlotlyCare. Each one gets a personalized invite link.",
        referral_name: "Name",
        referral_email: "Email",
        referral_add_another: "+ Add another colleague",
        referral_send: "Send Invitations",
        referral_error: "‚ùå Error sending invitations. Please try again.",
        referral_error_name: "Please enter a name for each colleague",
        referral_error_email: "Please enter a valid email for each colleague",
        referral_cancel: "Cancel",
        referral_copy_all: "üìã Copy All Links",
        referral_copied_all: "‚úÖ All links copied!",
        referral_personalized_note: "Each colleague will see a personalized page with your recommendation.",
        referral_your_link: "üîó Your personal referral link:",
        referral_link_explain: "Refer colleagues and they'll receive a personalized page with your recommendation.",
        referral_we_send_toggle: "Want SlotlyCare to send the invitation for you?",
        referral_we_send: "SlotlyCare will send",
        referral_you_send: "Copy and share",
        referral_list_title: "Your Referrals",
        referral_list_view: "View all",
        referral_status_pending: "Pending",
        referral_status_clicked: "Opened link",
        referral_status_trial: "Started trial",
        referral_status_converted: "Subscribed",
        referral_another: "Refer More",
        referral_close: "Close",
        referral_links_title_single: "Invitation created!",
        referral_links_title_plural: "invitations created!",
        referral_remove_row: "Remove",
        referral_stats_title: "Your Referrals",
        referral_stats_invited: "colleagues invited",
        referral_stats_opened: "opened your link",
        referral_stats_trial: "started a free trial",
        referral_stats_thanks: "SlotlyCare thanks you for your trust. üíö",
        referral_see_details: "See details",
        placeholders: {
            doctorName: "Dr. John",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    },
    pt: {
        title: "Configura√ß√£o SlotlyCare",
        logo_label: "Logo",
        optional_text: "(opcional)",
        upload_logo: "Escolher",
        remove_logo: "Remover",
        name_text: "Nome",
        specialty_text: "Especialidade",
        message_text: "Mensagem",
        additional_info_label: "Informa√ß√µes adicionais",
        additional_info_hint: "Ex: conv√™nios aceitos, valor da consulta, pol√≠tica de cancelamento",
        phone_label: "Telefone",
        email_label: "Email",
        address_label: "Endere√ßo",
        colors_label: "Cor",
        schedule_label: "Configura√ß√£o de Agenda IA",
        ai_intro: "Converse com a IA do SlotlyCare e automatize sua agenda m√©dica ‚Äî menos trabalho manual, menos erros, mais consultas confirmadas",
        ai_examples_title: "üí° Exemplos:",
        ai_example_1: "Segunda a sexta 9h-17h. S√°bado 8h-12h. Consultas de 30 minutos",
        ai_example_2: "Segunda a sexta 8h-18h, almo√ßo 12h-13h. Consultas de 30 minutos",
        ai_example_3: "Segunda, quarta e sexta 8h-18h. Ter√ßa e quinta 14h-20h. Consultas de 40 minutos",
        ai_example_4: "Segunda a sexta 9h-18h, consultas de 45 minutos. Bloquear 20 de dezembro a 5 de janeiro para f√©rias",
        ai_example_5: "Ter√ßa a s√°bado 10h-19h, mas quartas s√≥ at√© 15h. Consultas de 1 hora",
        generate_schedule: "Gerar Hor√°rios",
        save_config: "Salvar e Gerar Link",
        link_label: "Seu Link de Agendamento",
        link_placeholder: "Salve para gerar o link",
        copy_btn: "Copiar",
        preview_label: "Pr√©-visualiza√ß√£o ao Vivo",
        preview_select_date: "Selecione a Data da Consulta",
        preview_continue: "Agendar Consulta",
        preview_address: "Localiza√ß√£o",
        preview_phone: "Contato",
        preview_email_label: "Email",
        success_message: "‚úÖ Configura√ß√£o salva com sucesso!",
        schedule_processed: "‚úÖ Agenda processada!",
        copied: "Copiado!",
        referral_button: "üë• Indicar Colegas",
        referral_title: "Indicar Colegas",
        referral_subtitle: "Adicione colegas que poderiam se beneficiar do SlotlyCare. Cada um recebe um link de convite personalizado.",
        referral_name: "Nome",
        referral_email: "Email",
        referral_add_another: "+ Adicionar outro colega",
        referral_send: "Enviar Convites",
        referral_error: "‚ùå Erro ao enviar convites. Tente novamente.",
        referral_error_name: "Por favor, insira o nome de cada colega",
        referral_error_email: "Por favor, insira um email v√°lido para cada colega",
        referral_cancel: "Cancelar",
        referral_copy_all: "üìã Copiar Todos os Links",
        referral_copied_all: "‚úÖ Todos os links copiados!",
        referral_personalized_note: "Cada colega ver√° uma p√°gina personalizada com sua recomenda√ß√£o.",
        referral_your_link: "üîó Seu link pessoal de indica√ß√£o:",
        referral_link_explain: "Indique colegas e eles receber√£o uma p√°gina personalizada com sua recomenda√ß√£o.",
        referral_we_send_toggle: "Quer que a SlotlyCare envie o convite por voc√™?",
        referral_we_send: "SlotlyCare enviar√°",
        referral_you_send: "Copie e compartilhe",
        referral_list_title: "Suas Indica√ß√µes",
        referral_list_view: "Ver todas",
        referral_status_pending: "Pendente",
        referral_status_clicked: "Abriu o link",
        referral_status_trial: "Iniciou trial",
        referral_status_converted: "Assinou",
        referral_another: "Indicar Mais",
        referral_close: "Fechar",
        referral_links_title_single: "Convite criado!",
        referral_links_title_plural: "convites criados!",
        referral_remove_row: "Remover",
        referral_stats_title: "Suas Indica√ß√µes",
        referral_stats_invited: "colegas convidados",
        referral_stats_opened: "abriram seu link",
        referral_stats_trial: "iniciaram o teste gratuito",
        referral_stats_thanks: "A SlotlyCare agradece sua confian√ßa. üíö",
        referral_see_details: "Ver detalhes",
        placeholders: {
            doctorName: "Dr. Jo√£o",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    },
    es: {
        title: "Configuraci√≥n SlotlyCare",
        logo_label: "Logo",
        optional_text: "(opcional)",
        upload_logo: "Elegir",
        remove_logo: "Eliminar",
        name_text: "Nombre",
        specialty_text: "Especialidad",
        message_text: "Mensaje",
        additional_info_label: "Informaci√≥n adicional",
        additional_info_hint: "Ej: seguros aceptados, precio de consulta, pol√≠tica de cancelaci√≥n",
        phone_label: "Tel√©fono",
        email_label: "Email",
        address_label: "Direcci√≥n",
        colors_label: "Color",
        schedule_label: "Configuraci√≥n de Agenda IA",
        ai_intro: "Habla con la IA de SlotlyCare y automatiza tu agenda m√©dica ‚Äî menos trabajo manual, menos errores, m√°s citas confirmadas",
        ai_examples_title: "üí° Ejemplos:",
        ai_example_1: "Lunes a viernes 9h-17h. S√°bado 8h-12h. Consultas de 30 minutos",
        ai_example_2: "Lunes a viernes 8h-18h, almuerzo 12h-13h. Consultas de 30 minutos",
        ai_example_3: "Lunes, mi√©rcoles y viernes 8h-18h. Martes y jueves 14h-20h. Consultas de 40 minutos",
        ai_example_4: "Lunes a viernes 9h-18h, consultas de 45 minutos. Bloquear 20 de diciembre a 5 de enero por vacaciones",
        ai_example_5: "Martes a s√°bado 10h-19h, pero mi√©rcoles solo hasta 15h. Consultas de 1 hora",
        generate_schedule: "Generar Horarios",
        save_config: "Guardar y Generar Enlace",
        link_label: "Tu Enlace de Reserva",
        link_placeholder: "Guarda para generar el enlace",
        copy_btn: "Copiar",
        preview_label: "Vista Previa en Vivo",
        preview_select_date: "Selecciona Fecha de Cita",
        preview_continue: "Reservar Cita",
        preview_address: "Ubicaci√≥n",
        preview_phone: "Contacto",
        preview_email_label: "Email",
        success_message: "‚úÖ ¬°Configuraci√≥n guardada!",
        schedule_processed: "‚úÖ ¬°Agenda procesada!",
        copied: "¬°Copiado!",
        referral_button: "üë• Recomendar Colegas",
        referral_title: "Recomendar Colegas",
        referral_subtitle: "Agrega colegas que podr√≠an beneficiarse de SlotlyCare. Cada uno recibe un enlace de invitaci√≥n personalizado.",
        referral_name: "Nombre",
        referral_email: "Email",
        referral_add_another: "+ Agregar otro colega",
        referral_send: "Enviar Invitaciones",
        referral_error: "‚ùå Error al enviar. Int√©ntalo de nuevo.",
        referral_error_name: "Por favor, ingresa el nombre de cada colega",
        referral_error_email: "Por favor, ingresa un email v√°lido para cada colega",
        referral_cancel: "Cancelar",
        referral_copy_all: "üìã Copiar Todos los Enlaces",
        referral_copied_all: "‚úÖ ¬°Todos los enlaces copiados!",
        referral_personalized_note: "Cada colega ver√° una p√°gina personalizada con tu recomendaci√≥n.",
        referral_your_link: "üîó Tu enlace personal de referencia:",
        referral_link_explain: "Recomienda colegas y recibir√°n una p√°gina personalizada con tu recomendaci√≥n.",
        referral_we_send_toggle: "¬øQuieres que SlotlyCare env√≠e la invitaci√≥n por ti?",
        referral_we_send: "SlotlyCare enviar√°",
        referral_you_send: "Copia y comparte",
        referral_list_title: "Tus Recomendaciones",
        referral_list_view: "Ver todas",
        referral_status_pending: "Pendiente",
        referral_status_clicked: "Abri√≥ el enlace",
        referral_status_trial: "Inici√≥ prueba",
        referral_status_converted: "Se suscribi√≥",
        referral_another: "Recomendar M√°s",
        referral_close: "Cerrar",
        referral_links_title_single: "¬°Invitaci√≥n creada!",
        referral_links_title_plural: "invitaciones creadas!",
        referral_remove_row: "Eliminar",
        referral_stats_title: "Tus Recomendaciones",
        referral_stats_invited: "colegas invitados",
        referral_stats_opened: "abrieron tu enlace",
        referral_stats_trial: "iniciaron la prueba gratuita",
        referral_stats_thanks: "SlotlyCare agradece tu confianza. üíö",
        referral_see_details: "Ver detalles",
        placeholders: {
            doctorName: "Dr. Juan",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    },
    fr: {
        title: "Configuration SlotlyCare",
        logo_label: "Logo",
        optional_text: "(optionnel)",
        upload_logo: "Choisir",
        remove_logo: "Supprimer",
        name_text: "Nom",
        specialty_text: "Sp√©cialit√©",
        message_text: "Message",
        additional_info_label: "Informations compl√©mentaires",
        additional_info_hint: "Ex: assurances accept√©es, tarif de consultation, politique d'annulation",
        phone_label: "T√©l√©phone",
        email_label: "Email",
        address_label: "Adresse",
        colors_label: "Couleur",
        schedule_label: "Configuration de l'Agenda IA",
        ai_intro: "Parlez avec l'IA de SlotlyCare et automatisez votre agenda m√©dical ‚Äî moins de travail manuel, moins d'erreurs, plus de rendez-vous confirm√©s",
        ai_examples_title: "üí° Exemples:",
        ai_example_1: "Lundi √† vendredi 9h-17h. Samedi 8h-12h. Consultations de 30 minutes",
        ai_example_2: "Lundi √† vendredi 8h-18h, d√©jeuner 12h-13h. Consultations de 30 minutes",
        ai_example_3: "Lundi, mercredi et vendredi 8h-18h. Mardi et jeudi 14h-20h. Consultations de 40 minutes",
        ai_example_4: "Lundi √† vendredi 9h-18h, consultations de 45 minutes. Bloquer du 20 d√©cembre au 5 janvier pour vacances",
        ai_example_5: "Mardi √† samedi 10h-19h, mais mercredi seulement jusqu'√† 15h. Consultations de 1 heure",
        generate_schedule: "G√©n√©rer les Cr√©neaux",
        save_config: "Enregistrer et G√©n√©rer le Lien",
        link_label: "Votre Lien de R√©servation",
        link_placeholder: "Enregistrez pour g√©n√©rer le lien",
        copy_btn: "Copier",
        preview_label: "Aper√ßu en Direct",
        preview_select_date: "S√©lectionnez la Date du Rendez-vous",
        preview_continue: "R√©server un Rendez-vous",
        preview_address: "Localisation",
        preview_phone: "Contact",
        preview_email_label: "Email",
        success_message: "‚úÖ Configuration enregistr√©e!",
        schedule_processed: "‚úÖ Agenda trait√©!",
        copied: "Copi√©!",
        referral_button: "üë• Recommander des Coll√®gues",
        referral_title: "Recommander des Coll√®gues",
        referral_subtitle: "Ajoutez des coll√®gues qui pourraient b√©n√©ficier de SlotlyCare. Chacun re√ßoit un lien d'invitation personnalis√©.",
        referral_name: "Nom",
        referral_email: "Email",
        referral_add_another: "+ Ajouter un autre coll√®gue",
        referral_send: "Envoyer les Invitations",
        referral_error: "‚ùå Erreur lors de l'envoi. Veuillez r√©essayer.",
        referral_error_name: "Veuillez entrer le nom de chaque coll√®gue",
        referral_error_email: "Veuillez entrer un email valide pour chaque coll√®gue",
        referral_cancel: "Annuler",
        referral_copy_all: "üìã Copier Tous les Liens",
        referral_copied_all: "‚úÖ Tous les liens copi√©s !",
        referral_personalized_note: "Chaque coll√®gue verra une page personnalis√©e avec votre recommandation.",
        referral_your_link: "üîó Votre lien personnel de parrainage :",
        referral_link_explain: "Recommandez des coll√®gues et ils recevront une page personnalis√©e avec votre recommandation.",
        referral_we_send_toggle: "Vous voulez que SlotlyCare envoie l'invitation pour vous ?",
        referral_we_send: "SlotlyCare enverra",
        referral_you_send: "Copiez et partagez",
        referral_list_title: "Vos Recommandations",
        referral_list_view: "Voir toutes",
        referral_status_pending: "En attente",
        referral_status_clicked: "Lien ouvert",
        referral_status_trial: "Essai d√©marr√©",
        referral_status_converted: "Abonn√©",
        referral_another: "Recommander Plus",
        referral_close: "Fermer",
        referral_links_title_single: "Invitation cr√©√©e !",
        referral_links_title_plural: "invitations cr√©√©es !",
        referral_remove_row: "Supprimer",
        referral_stats_title: "Vos Recommandations",
        referral_stats_invited: "coll√®gues invit√©s",
        referral_stats_opened: "ont ouvert votre lien",
        referral_stats_trial: "ont commenc√© l'essai gratuit",
        referral_stats_thanks: "SlotlyCare vous remercie pour votre confiance. üíö",
        referral_see_details: "Voir les d√©tails",
        placeholders: {
            doctorName: "Dr. Jean",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    },
    de: {
        title: "SlotlyCare-Konfiguration",
        logo_label: "Logo",
        optional_text: "(optional)",
        upload_logo: "W√§hlen",
        remove_logo: "Entfernen",
        name_text: "Name",
        specialty_text: "Fachrichtung",
        message_text: "Nachricht",
        additional_info_label: "Zus√§tzliche Informationen",
        additional_info_hint: "Z.B.: akzeptierte Versicherungen, Beratungsgeb√ºhr, Stornierungsbedingungen",
        phone_label: "Telefon",
        email_label: "Email",
        address_label: "Adresse",
        colors_label: "Farbe",
        schedule_label: "KI-Terminplanung",
        ai_intro: "Sprechen Sie mit der SlotlyCare KI und automatisieren Sie Ihren medizinischen Zeitplan ‚Äî weniger manuelle Arbeit, weniger Fehler, mehr best√§tigte Termine",
        ai_examples_title: "üí° Beispiele:",
        ai_example_1: "Montag bis Freitag 9-17 Uhr. Samstag 8-12 Uhr. 30-min√ºtige Termine",
        ai_example_2: "Montag bis Freitag 8-18 Uhr, Mittagspause 12-13 Uhr. 30-min√ºtige Termine",
        ai_example_3: "Montag, Mittwoch und Freitag 8-18 Uhr. Dienstag und Donnerstag 14-20 Uhr. 40-min√ºtige Termine",
        ai_example_4: "Montag bis Freitag 9-18 Uhr, 45-min√ºtige Termine. 20. Dezember bis 5. Januar f√ºr Urlaub blockieren",
        ai_example_5: "Dienstag bis Samstag 10-19 Uhr, aber Mittwoch nur bis 15 Uhr. 1-st√ºndige Termine",
        generate_schedule: "Zeitfenster Generieren",
        save_config: "Speichern und Link Generieren",
        link_label: "Ihr pers√∂nlicher Buchungslink",
        link_placeholder: "Speichern um Link zu generieren",
        copy_btn: "Kopieren",
        preview_label: "Live-Vorschau",
        preview_select_date: "W√§hlen Sie das Terminsdatum",
        preview_continue: "Termin Buchen",
        preview_address: "Standort",
        preview_phone: "Kontakt",
        preview_email_label: "E-Mail",
        success_message: "‚úÖ Konfiguration gespeichert!",
        schedule_processed: "‚úÖ Zeitplan verarbeitet!",
        copied: "Kopiert!",
        referral_button: "üë• Kollegen Empfehlen",
        referral_title: "Kollegen Empfehlen",
        referral_subtitle: "F√ºgen Sie Kollegen hinzu, die von SlotlyCare profitieren k√∂nnten. Jeder erh√§lt einen personalisierten Einladungslink.",
        referral_name: "Name",
        referral_email: "Email",
        referral_add_another: "+ Weiteren Kollegen hinzuf√ºgen",
        referral_send: "Einladungen Senden",
        referral_error: "‚ùå Fehler beim Senden. Bitte versuchen Sie es erneut.",
        referral_error_name: "Bitte geben Sie den Namen jedes Kollegen ein",
        referral_error_email: "Bitte geben Sie eine g√ºltige Email f√ºr jeden Kollegen ein",
        referral_cancel: "Abbrechen",
        referral_copy_all: "üìã Alle Links Kopieren",
        referral_copied_all: "‚úÖ Alle Links kopiert!",
        referral_personalized_note: "Jeder Kollege sieht eine personalisierte Seite mit Ihrer Empfehlung.",
        referral_your_link: "üîó Ihr pers√∂nlicher Empfehlungslink:",
        referral_link_explain: "Empfehlen Sie Kollegen und sie erhalten eine personalisierte Seite mit Ihrer Empfehlung.",
        referral_we_send_toggle: "M√∂chten Sie, dass SlotlyCare die Einladung f√ºr Sie sendet?",
        referral_we_send: "SlotlyCare wird senden",
        referral_you_send: "Kopieren und teilen",
        referral_list_title: "Ihre Empfehlungen",
        referral_list_view: "Alle anzeigen",
        referral_status_pending: "Ausstehend",
        referral_status_clicked: "Link ge√∂ffnet",
        referral_status_trial: "Testversion gestartet",
        referral_status_converted: "Abonniert",
        referral_another: "Weitere Empfehlen",
        referral_close: "Schlie√üen",
        referral_links_title_single: "Einladung erstellt!",
        referral_links_title_plural: "Einladungen erstellt!",
        referral_remove_row: "Entfernen",
        referral_stats_title: "Ihre Empfehlungen",
        referral_stats_invited: "Kollegen eingeladen",
        referral_stats_opened: "haben Ihren Link ge√∂ffnet",
        referral_stats_trial: "haben die Testversion gestartet",
        referral_stats_thanks: "SlotlyCare dankt Ihnen f√ºr Ihr Vertrauen. üíö",
        referral_see_details: "Details ansehen",
        placeholders: {
            doctorName: "Dr. Hans",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    },
    it: {
        title: "Configurazione SlotlyCare",
        logo_label: "Logo",
        optional_text: "(opzionale)",
        upload_logo: "Scegli",
        remove_logo: "Rimuovi",
        name_text: "Nome",
        specialty_text: "Specialit√†",
        message_text: "Messaggio",
        additional_info_label: "Informazioni aggiuntive",
        additional_info_hint: "Es: assicurazioni accettate, costo della visita, politica di cancellazione",
        phone_label: "Telefono",
        email_label: "Email",
        address_label: "Indirizzo",
        colors_label: "Colore",
        schedule_label: "Configurazione Agenda IA",
        ai_intro: "Parla con l'IA di SlotlyCare e automatizza la tua agenda medica ‚Äî meno lavoro manuale, meno errori, pi√π appuntamenti confermati",
        ai_examples_title: "üí° Esempi:",
        ai_example_1: "Luned√¨ a venerd√¨ 9-17. Sabato 8-12. Appuntamenti di 30 minuti",
        ai_example_2: "Luned√¨ a venerd√¨ 8-18, pranzo 12-13. Appuntamenti di 30 minuti",
        ai_example_3: "Luned√¨, mercoled√¨ e venerd√¨ 8-18. Marted√¨ e gioved√¨ 14-20. Appuntamenti di 40 minuti",
        ai_example_4: "Luned√¨ a venerd√¨ 9-18, appuntamenti di 45 minuti. Bloccare dal 20 dicembre al 5 gennaio per ferie",
        ai_example_5: "Marted√¨ a sabato 10-19, ma mercoled√¨ solo fino alle 15. Appuntamenti di 1 ora",
        generate_schedule: "Genera Orari",
        save_config: "Salva e Genera Link",
        link_label: "Il Tuo Link di Prenotazione",
        link_placeholder: "Salva per generare il link",
        copy_btn: "Copia",
        preview_label: "Anteprima Live",
        preview_select_date: "Seleziona Data Appuntamento",
        preview_continue: "Prenota Appuntamento",
        preview_address: "Posizione",
        preview_phone: "Contatto",
        preview_email_label: "Email",
        success_message: "‚úÖ Configurazione salvata!",
        schedule_processed: "‚úÖ Agenda elaborata!",
        copied: "Copiato!",
        referral_button: "üë• Consiglia Colleghi",
        referral_title: "Consiglia Colleghi",
        referral_subtitle: "Aggiungi colleghi che potrebbero beneficiare di SlotlyCare. Ognuno riceve un link di invito personalizzato.",
        referral_name: "Nome",
        referral_email: "Email",
        referral_add_another: "+ Aggiungi un altro collega",
        referral_send: "Invia Inviti",
        referral_error: "‚ùå Errore nell'invio. Riprova.",
        referral_error_name: "Inserisci il nome di ogni collega",
        referral_error_email: "Inserisci un email valido per ogni collega",
        referral_cancel: "Annulla",
        referral_copy_all: "üìã Copia Tutti i Link",
        referral_copied_all: "‚úÖ Tutti i link copiati!",
        referral_personalized_note: "Ogni collega vedr√† una pagina personalizzata con la tua raccomandazione.",
        referral_your_link: "üîó Il tuo link personale di referral:",
        referral_link_explain: "Consiglia colleghi e riceveranno una pagina personalizzata con la tua raccomandazione.",
        referral_we_send_toggle: "Vuoi che SlotlyCare invii l'invito per te?",
        referral_we_send: "SlotlyCare invier√†",
        referral_you_send: "Copia e condividi",
        referral_list_title: "I Tuoi Referral",
        referral_list_view: "Vedi tutti",
        referral_status_pending: "In attesa",
        referral_status_clicked: "Link aperto",
        referral_status_trial: "Prova iniziata",
        referral_status_converted: "Abbonato",
        referral_another: "Consiglia Altri",
        referral_close: "Chiudi",
        referral_links_title_single: "Invito creato!",
        referral_links_title_plural: "inviti creati!",
        referral_remove_row: "Rimuovi",
        referral_stats_title: "Le Tue Raccomandazioni",
        referral_stats_invited: "colleghi invitati",
        referral_stats_opened: "hanno aperto il tuo link",
        referral_stats_trial: "hanno iniziato la prova gratuita",
        referral_stats_thanks: "SlotlyCare ti ringrazia per la tua fiducia. üíö",
        referral_see_details: "Vedi dettagli",
        placeholders: {
            doctorName: "Dr. Giovanni",
            specialty: "",
            address: "",
            phone: "",
            email: "",
            welcomeMsg: "",
            scheduleInput: ""
        }
    }
};

let currentLanguage = 'en';
let currentPrimaryColor = '#2563eb';
let currentSecondaryColor = '#10b981';

function applyTranslations() {
    const langData = translations[currentLanguage] || translations['en'];
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (langData[key]) el.textContent = langData[key];
    });

    // Lista de nomes padr√£o em todos os idiomas
    const defaultNames = ['Dr. John', 'Dr. Jo√£o', 'Dr. Juan', 'Dr. Jean', 'Dr. Hans', 'Dr. Giovanni'];
    const doctorNameInput = document.getElementById('doctorName');
    
    // Se o nome atual √© um dos padr√µes, atualiza para o nome do idioma atual
    if (defaultNames.includes(doctorNameInput.value)) {
        doctorNameInput.value = langData.placeholders.doctorName;
    }

    if (langData.placeholders) {
        for (const id in langData.placeholders) {
            const el = document.getElementById(id);
            if (el && el.tagName !== 'INPUT' || (el.tagName === 'INPUT' && !el.value)) {
                el.placeholder = langData.placeholders[id];
            }
        }
    }

    const titleEl = document.getElementById('mainTitle');
    titleEl.textContent = langData.title;
    
    updatePreview();
}

function updatePreview() {
    const langData = translations[currentLanguage] || translations['en'];
    
    const name = document.getElementById('doctorName').value;
    document.getElementById('previewDoctorName').textContent = name || langData.placeholders.doctorName;

    const spec = document.getElementById('specialty').value;
    const specEl = document.getElementById('previewSpecialty');
    if (spec) {
        specEl.textContent = spec;
        specEl.classList.add('active');
    } else {
        specEl.textContent = langData.placeholders.specialty;
        specEl.classList.add('active');
    }

    const addr = document.getElementById('address').value;
    document.getElementById('previewAddress').innerHTML = (addr || langData.placeholders.address).replace(/\n/g, '<br>');

    const phone = document.getElementById('phone').value;
    document.getElementById('previewPhone').textContent = phone || langData.placeholders.phone;

    const email = document.getElementById('email').value;
    document.getElementById('previewEmail').textContent = email || langData.placeholders.email;

    const msg = document.getElementById('welcomeMsg').value;
    const msgEl = document.getElementById('previewQuote');
    if (msg) {
        msgEl.textContent = msg;
        msgEl.classList.add('active');
    } else {
        msgEl.classList.remove('active');
    }

    const additionalInfo = document.getElementById('additionalInfo').value;
    const additionalInfoContainer = document.getElementById('previewAdditionalInfoContainer');
    const additionalInfoEl = document.getElementById('previewAdditionalInfo');
    if (additionalInfo) {
        additionalInfoEl.innerHTML = additionalInfo.replace(/\n/g, '<br>');
        additionalInfoContainer.style.display = 'block';
    } else {
        additionalInfoContainer.style.display = 'none';
    }
}

['doctorName', 'specialty', 'address', 'phone', 'email', 'welcomeMsg', 'additionalInfo'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
});

// Gerar sugest√£o de link quando o nome mudar
document.getElementById('doctorName').addEventListener('input', function() {
    const customLinkInput = document.getElementById('customLink');
    
    // S√≥ gera sugest√£o se o campo estiver vazio
    if (!customLinkInput.value || customLinkInput.value === customLinkInput.getAttribute('data-last-suggestion')) {
        const suggestion = generateLinkSuggestion(this.value);
        customLinkInput.value = suggestion;
        customLinkInput.setAttribute('data-last-suggestion', suggestion);
    }
});

// Validar link enquanto digita
// Vari√°vel para controlar debounce da verifica√ß√£o de link
let linkCheckTimeout = null;

document.getElementById('customLink').addEventListener('input', function() {
    let value = this.value;
    
    // Limpar caracteres inv√°lidos em tempo real
    value = value
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/[^a-z0-9-]/g, '') // S√≥ permite letras, n√∫meros e h√≠fens
        .replace(/^-+|-+$/g, '') // Remove h√≠fens do in√≠cio e fim
        .replace(/-{2,}/g, '-'); // Remove h√≠fens duplicados
    
    this.value = value;
    
    // Feedback visual
    const availabilityDiv = document.getElementById('linkAvailability');
    if (value.length >= 3) {
        availabilityDiv.style.display = 'block';
        availabilityDiv.innerHTML = '‚è≥ Checking availability...';
        availabilityDiv.style.color = '#64748B';
        
        // Cancelar verifica√ß√£o anterior (debounce)
        if (linkCheckTimeout) {
            clearTimeout(linkCheckTimeout);
        }
        
        // Aguardar 500ms ap√≥s parar de digitar para verificar
        linkCheckTimeout = setTimeout(async () => {
            // Se √© o mesmo link j√° salvo, est√° dispon√≠vel (√© do pr√≥prio usu√°rio)
            if (savedDoctorLink && savedDoctorLink === value) {
                availabilityDiv.innerHTML = '‚úì Available (your current link)';
                availabilityDiv.style.color = '#10B981';
                return;
            }
            
            try {
                const response = await fetch(`https://slotlycare-backend.vercel.app/api/get-doctor?id=${value}`);
                const data = await response.json();
                
                if (data.success) {
                    // Link j√° existe
                    availabilityDiv.innerHTML = '‚úó Already taken';
                    availabilityDiv.style.color = '#EF4444';
                } else {
                    // Link dispon√≠vel
                    availabilityDiv.innerHTML = '‚úì Available';
                    availabilityDiv.style.color = '#10B981';
                }
            } catch (e) {
                // Erro na API (provavelmente 404 = n√£o existe = dispon√≠vel)
                availabilityDiv.innerHTML = '‚úì Available';
                availabilityDiv.style.color = '#10B981';
            }
        }, 500);
    } else {
        availabilityDiv.style.display = 'none';
    }
});

function generateLinkSuggestion(name) {
    if (!name) return '';
    
    return name
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/^(dr\.?|dra\.?|doctor|doctora)\s*/i, '') // Remove Dr, Dra
        .replace(/[^a-z0-9\s-]/g, '') // Remove caracteres especiais
        .trim()
        .replace(/\s+/g, '-') // Espa√ßos ‚Üí h√≠fens
        .replace(/-+/g, '-') // Remove h√≠fens duplicados
        .replace(/^-|-$/g, '') // Remove h√≠fens das pontas
        .substring(0, 50) // Limita tamanho
        || 'my-clinic'; // Fallback se ficar vazio
}

document.getElementById('languageSelector').addEventListener('change', (e) => {
    currentLanguage = e.target.value;
    applyTranslations();
    localStorage.setItem('slotly_lang', currentLanguage);
});

document.getElementById('logoUpload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        // Verificar se √© imagem
        if (!file.type.startsWith('image/')) {
            showMessage('Please select an image file (JPG, PNG, etc.)', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Criar canvas para redimensionar
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Tamanho m√°ximo 150x150
                const maxSize = 150;
                let width = img.width;
                let height = img.height;
                
                // Calcular novo tamanho mantendo propor√ß√£o
                if (width > height) {
                    if (width > maxSize) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converter para base64 com qualidade 70%
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // Verificar tamanho
                if (compressedBase64.length > 40000) {
                    showMessage('Image is too large. Please use a smaller or simpler logo.', 'error');
                    document.getElementById('logoUpload').value = '';
                    return;
                }
                
                // Aplicar no preview
                const logo = document.getElementById('previewLogo');
                logo.src = compressedBase64;
                logo.classList.add('active');
                document.getElementById('btnRemoveLogo').style.display = 'block';
                
                console.log('Logo compressed:', Math.round(compressedBase64.length / 1024) + 'KB');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
});

function removeLogo() {
    const logo = document.getElementById('previewLogo');
    logo.classList.remove('active');
    logo.style.display = '';
    logo.src = '';
    document.getElementById('logoUpload').value = '';
    document.getElementById('btnRemoveLogo').style.display = 'none';
}

document.querySelectorAll('.color-swatch').forEach(swatch => {
    swatch.addEventListener('click', function() {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        this.classList.add('active');
        currentPrimaryColor = this.dataset.color;
        currentSecondaryColor = this.dataset.secondary;
        
        document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${currentPrimaryColor} 0%, ${currentSecondaryColor} 100%)`;
        document.getElementById('previewButton').style.background = `linear-gradient(135deg, ${currentPrimaryColor} 0%, ${currentSecondaryColor} 100%)`;
        
        const selectedDay = document.querySelector('.preview-day.selected');
        if (selectedDay) {
            selectedDay.style.background = currentPrimaryColor;
            selectedDay.style.borderColor = currentPrimaryColor;
        }
    });
});

function tryExample(button, exampleNumber) {
    const listItem = button.parentElement;
    const exampleText = listItem.getAttribute('data-example-' + currentLanguage);
    
    if (exampleText) {
        document.getElementById('scheduleInput').value = exampleText;
        
        // Visual feedback
        button.textContent = '‚úì Loaded';
        button.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
        
        setTimeout(() => {
            button.innerHTML = '‚ú® Try';
            button.style.background = '';
        }, 1500);
        
        // Focus no textarea
        document.getElementById('scheduleInput').focus();
    }
}

async function saveConfiguration() {
    // Valida√ß√£o de campos obrigat√≥rios
    const doctorName = document.getElementById('doctorName').value.trim();
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const customLink = document.getElementById('customLink').value.trim();
    
    // Debug logs
    console.log('=== VALIDATION DEBUG ===');
    console.log('doctorName:', doctorName, '| length:', doctorName.length);
    console.log('address:', address, '| length:', address.length);
    console.log('phone:', phone, '| length:', phone.length);
    console.log('email:', email, '| length:', email.length);
    console.log('customLink:', customLink, '| length:', customLink.length);
    console.log('savedDoctorLink:', savedDoctorLink);
    console.log('pendingLinkChange:', pendingLinkChange);
    
    if (!doctorName || !address || !phone || !email) {
        const missing = [];
        if (!doctorName) missing.push('Name');
        if (!address) missing.push('Address');
        if (!phone) missing.push('Phone');
        if (!email) missing.push('Email');
        
        showMessage('Please fill in all required fields: ' + missing.join(', '), 'error');
        console.log('Missing fields:', missing);
        return;
    }
    
    // Validar link personalizado
    if (!customLink || customLink.length < 3) {
        showMessage('Please enter a custom link (minimum 3 characters)', 'error');
        return;
    }
    
    // Valida√ß√£o de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address', 'error');
        return;
    }
    
    // VERIFICAR SE LINK J√Å EXISTE (para novos m√©dicos ou mudan√ßa de link)
    if (!savedDoctorLink || savedDoctorLink !== customLink) {
        try {
            const checkResponse = await fetch(`https://slotlycare-backend.vercel.app/api/get-doctor?id=${customLink}`);
            const checkData = await checkResponse.json();
            
            if (checkData.success) {
                // Link j√° existe
                showMessage('This link is already taken. Please choose another one.', 'error');
                document.getElementById('customLink').focus();
                return;
            }
        } catch (e) {
            // Se der erro 404, significa que n√£o existe - podemos continuar
            console.log('Link available:', customLink);
        }
    }
    
    // VERIFICAR SE EST√Å MUDANDO O LINK
    if (savedDoctorLink && savedDoctorLink !== customLink && !pendingLinkChange) {
        // Mostrar modal de confirma√ß√£o
        showLinkChangeModal(savedDoctorLink, customLink);
        return; // Interrompe aqui, aguarda confirma√ß√£o
    }
    
    // Reset pendingLinkChange ap√≥s confirma√ß√£o
    if (pendingLinkChange) {
        pendingLinkChange = false;
    }
    
    const btn = document.getElementById('btnSave');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';
    
    try {
        // Usar o link personalizado
        const doctorId = customLink;
        
        // Obter logo em base64 (se tiver)
        const logoElement = document.getElementById('previewLogo');
        const logoUrl = logoElement.src && logoElement.src !== window.location.href ? logoElement.src : '';
        
        // Preparar dados para enviar
        const doctorData = {
            id: doctorId,
            name: doctorName,
            specialty: document.getElementById('specialty').value.trim() || '',
            address: address,
            phone: phone,
            email: email,
            logo_url: logoUrl,
            color: currentPrimaryColor,
            language: currentLanguage,
            welcome_message: document.getElementById('welcomeMsg').value.trim() || '',
            additional_info: document.getElementById('additionalInfo').value.trim() || '',
            link: doctorId,
            slots: generatedSlots, // Slots gerados pela IA
            customer_id: localStorage.getItem('slotlycare_customer_id') || '' // Vincular ao Stripe
        };
        
        // Enviar para API
        const response = await fetch('https://slotlycare-backend.vercel.app/api/save-doctor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(doctorData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Salvar link atual para futuras compara√ß√µes
            savedDoctorLink = doctorId;
            
            // Atualizar link na interface
            const fullLink = `https://slotlycare.com/${doctorId}`;
            document.getElementById('bookingLink').textContent = fullLink;
            
            // Calcular data de expira√ß√£o (180 dias)
            const today = new Date();
            const expirationDate = new Date(today);
            expirationDate.setDate(today.getDate() + 180);
            const expirationStr = expirationDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Mensagem de sucesso com data de expira√ß√£o
            let successMsg = '‚úÖ Configuration saved successfully!';
            if (data.slots_saved && data.slots_saved > 0) {
                successMsg += `\n\nüìÖ Your scheduling is active until ${expirationStr} (6 months)\nüí° Remember to regenerate slots before this date to keep accepting appointments`;
            }
            showMessage(successMsg, 'success');
            
            // Limpar slots gerados
            generatedSlots = [];
        } else {
            // Se o link j√° existe, mostrar mensagem espec√≠fica
            if (data.error && data.error.includes('already taken')) {
                showMessage('This link is already taken. Please choose another one.', 'error');
                document.getElementById('customLink').focus();
            } else {
                showMessage('Error: ' + (data.error || 'Failed to save configuration'), 'error');
            }
        }
        
    } catch (error) {
        console.error('Save error:', error);
        showMessage('Connection error: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function showMessage(text, type) {
    const msgDiv = document.getElementById('successMessage');
    // Substituir \n por <br> para mostrar quebras de linha
    msgDiv.innerHTML = text.replace(/\n/g, '<br>');
    msgDiv.style.display = 'block';
    msgDiv.style.position = 'fixed';
    msgDiv.style.top = '20px';
    msgDiv.style.left = '50%';
    msgDiv.style.transform = 'translateX(-50%)';
    msgDiv.style.zIndex = '9999';
    msgDiv.style.minWidth = '300px';
    msgDiv.style.maxWidth = '600px';
    msgDiv.style.whiteSpace = 'pre-line';
    msgDiv.style.textAlign = 'left';
    msgDiv.className = `message ${type}`;
    setTimeout(() => msgDiv.style.display = 'none', 8000); // 8s para mensagens mais longas
}

function copyLink() {
    const link = document.getElementById('bookingLink').textContent;
    navigator.clipboard.writeText(link);
    const btn = document.querySelector('.btn-copy');
    const originalText = btn.textContent;
    btn.textContent = translations[currentLanguage].copied;
    setTimeout(() => btn.textContent = originalText, 2000);
}

// ========== SISTEMA DE IA E LIMITE ==========
const MAX_GENERATIONS_PER_DAY = 10;
const API_ENDPOINT = 'https://slotlycare-backend.vercel.app/api/schedule';

// Global variables
let generatedSlots = [];
let savedDoctorLink = null; // Armazena o link salvo anteriormente
let pendingLinkChange = false;

// Fun√ß√µes do Modal
function showLinkChangeModal(oldLink, newLink) {
    document.getElementById('modalOldLink').textContent = `Old: https://slotlycare.com/${oldLink}`;
    document.getElementById('modalNewLink').textContent = `New: https://slotlycare.com/${newLink}`;
    document.getElementById('linkChangeModal').classList.add('active');
}

function cancelLinkChange() {
    document.getElementById('linkChangeModal').classList.remove('active');
    pendingLinkChange = false;
}

function confirmLinkChange() {
    document.getElementById('linkChangeModal').classList.remove('active');
    pendingLinkChange = true;
    // Continua com o save
    saveConfiguration();
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(e) {
    const modal = document.getElementById('linkChangeModal');
    if (e.target === modal) {
        cancelLinkChange();
    }
});

function checkDailyLimit() {
    const today = new Date().toISOString().split('T')[0];
    const stored = localStorage.getItem('slotly_generations');
    
    if (!stored) {
        localStorage.setItem('slotly_generations', JSON.stringify({date: today, count: 0}));
        return {allowed: true, remaining: MAX_GENERATIONS_PER_DAY};
    }
    
    const data = JSON.parse(stored);
    
    if (data.date !== today) {
        localStorage.setItem('slotly_generations', JSON.stringify({date: today, count: 0}));
        return {allowed: true, remaining: MAX_GENERATIONS_PER_DAY};
    }
    
    if (data.count >= MAX_GENERATIONS_PER_DAY) {
        return {allowed: false, remaining: 0};
    }
    
    return {allowed: true, remaining: MAX_GENERATIONS_PER_DAY - data.count};
}

function incrementGenerationCount() {
    const today = new Date().toISOString().split('T')[0];
    const stored = localStorage.getItem('slotly_generations');
    const data = stored ? JSON.parse(stored) : {date: today, count: 0};
    
    data.count++;
    data.date = today;
    localStorage.setItem('slotly_generations', JSON.stringify(data));
}

async function processSchedule() {
    const scheduleText = document.getElementById('scheduleInput').value.trim();
    
    if (!scheduleText) {
        showMessage('Please describe your schedule', 'error');
        return;
    }
    
    const limitCheck = checkDailyLimit();
    if (!limitCheck.allowed) {
        showMessage('Daily limit of ' + MAX_GENERATIONS_PER_DAY + ' generations reached. Try again tomorrow!', 'error');
        return;
    }
    
    const btn = document.getElementById('btnProcessSchedule');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Processing...';
    
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({schedule_text: scheduleText})
        });
        
        const data = await response.json();
        
        if (data.success) {
            incrementGenerationCount();
            const remaining = limitCheck.remaining - 1;
            
            // Armazenar slots gerados na vari√°vel global
            generatedSlots = data.slots;
            
            // Mostrar preview dos slots COM o texto original
            showSlotsPreview(data.slots, data.total_slots, remaining, scheduleText);
            
            console.log('Generated slots stored:', generatedSlots.length);
        } else {
            showMessage('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showMessage('Connection error: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function showSlotsPreview(slots, total, remaining, originalText) {
    // Criar HTML do preview simplificado
    let previewHTML = `
        <div style="background: white; padding: 24px; border-radius: 12px; max-width: 700px; margin: 20px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <h3 style="margin: 0 0 20px 0; color: #1E293B; font-size: 1.3rem;">
                ‚úÖ Schedule Generated Successfully!
            </h3>
            
            <div style="background: #F0F9FF; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3B82F6;">
                <p style="margin: 0 0 8px 0; font-weight: 600; color: #1E293B;">üìù Your request:</p>
                <p style="margin: 0; color: #475569; font-style: italic; line-height: 1.6;">
                    "${originalText}"
                </p>
            </div>
            
            <div style="background: #F8FAFC; padding: 14px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #64748B;">
                <p style="margin: 0; color: #475569; font-size: 0.95rem;">
                    ‚ÑπÔ∏è Scheduling generated for the next 6 months (180 days)<br>
                    ‚ö° <strong>${remaining} generations</strong> remaining today
                </p>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button onclick="previewPatientView()" style="flex: 1; min-width: 140px; background: #10B981; color: white; border: none; padding: 12px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    üëÅÔ∏è Preview Patient View
                </button>
                <button onclick="closeSlotsPreview()" style="background: #F1F5F9; color: #475569; border: none; padding: 12px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    ‚ùå Discard
                </button>
                <button onclick="confirmSlotsPreview()" style="background: #3B82F6; color: white; border: none; padding: 12px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    ‚úÖ Looks Good!
                </button>
            </div>
        </div>
    `;
    
    // Criar ou atualizar container do preview
    let previewContainer = document.getElementById('slotsPreviewContainer');
    if (!previewContainer) {
        previewContainer = document.createElement('div');
        previewContainer.id = 'slotsPreviewContainer';
        previewContainer.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto; padding: 20px;';
        document.body.appendChild(previewContainer);
    }
    
    previewContainer.innerHTML = previewHTML;
    previewContainer.style.display = 'block';
}

function previewPatientView() {
    // Salvar slots temporariamente no sessionStorage
    sessionStorage.setItem('tempPreviewSlots', JSON.stringify(generatedSlots));
    
    // Fun√ß√£o helper para pegar valor com seguran√ßa
    const getFieldValue = (id, defaultValue = '') => {
        const element = document.getElementById(id);
        return element ? (element.value || defaultValue) : defaultValue;
    };
    
    // Pegar logo (√© uma imagem, n√£o um input de texto)
    const logoElement = document.getElementById('previewLogo');
    const logoUrl = (logoElement && logoElement.src && !logoElement.src.includes('data:,') && logoElement.src !== window.location.href) 
        ? logoElement.src 
        : '';
    
    // Obter dados do m√©dico do formul√°rio
    const doctorData = {
        id: 'preview-temp',
        name: getFieldValue('doctorName', 'Dr. Preview'),
        specialty: getFieldValue('specialty', ''),
        address: getFieldValue('address', 'Address not set'),
        phone: getFieldValue('phone', 'Phone not set'),
        email: getFieldValue('email', ''),
        logo_url: logoUrl,
        color: currentPrimaryColor || '#3B82F6',
        language: currentLanguage || 'en',
        welcome_message: getFieldValue('welcomeMsg', ''),
        additional_info: getFieldValue('additionalInfo', ''),
        link: 'preview'
    };
    
    sessionStorage.setItem('tempPreviewDoctor', JSON.stringify(doctorData));
    
    // Abrir p√°gina REAL do paciente em nova aba
    window.open('/paciente.html', '_blank');
    
    showMessage('Opening patient view preview in new tab...', 'info');
}

function analyzeSchedulePattern(slotsByDate, allDates) {
    // Detectar padr√£o normal (mais comum)
    const slotCounts = {};
    allDates.forEach(date => {
        const count = slotsByDate[date].length;
        slotCounts[count] = (slotCounts[count] || 0) + 1;
    });
    
    const mostCommonCount = Object.keys(slotCounts).reduce((a, b) => 
        slotCounts[a] > slotCounts[b] ? a : b
    );
    
    const regularDays = allDates.filter(date => 
        slotsByDate[date].length === parseInt(mostCommonCount)
    );
    
    const exceptions = [];
    
    // Detectar dias com hor√°rios diferentes
    const irregularDays = allDates.filter(date => 
        slotsByDate[date].length !== parseInt(mostCommonCount)
    );
    
    irregularDays.forEach(date => {
        const dateObj = new Date(date + 'T00:00:00');
        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        exceptions.push({
            type: 'different_hours',
            date: date,
            label: `${dayName}, ${formattedDate} (${slotsByDate[date].length} slots)`
        });
    });
    
    // Detectar per√≠odos bloqueados (gaps consecutivos)
    let blockedStart = null;
    let consecutiveBlocked = 0;
    
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(today.getDate() + 90);
    
    let currentDate = new Date(today);
    while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        
        if (!slotsByDate[dateStr]) {
            if (!blockedStart) {
                blockedStart = dateStr;
                consecutiveBlocked = 1;
            } else {
                consecutiveBlocked++;
            }
        } else {
            if (blockedStart && consecutiveBlocked >= 3) {
                const prevDate = new Date(currentDate);
                prevDate.setDate(prevDate.getDate() - 1);
                const endStr = prevDate.toISOString().split('T')[0];
                
                const startFormatted = new Date(blockedStart + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = new Date(endStr + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                exceptions.push({
                    type: 'blocked_range',
                    start: startFormatted,
                    end: endFormatted,
                    days: consecutiveBlocked
                });
            }
            blockedStart = null;
            consecutiveBlocked = 0;
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return {
        regularDays: regularDays.slice(0, 5),
        exceptions: exceptions.slice(0, 5)
    };
}

function closeSlotsPreview() {
    const container = document.getElementById('slotsPreviewContainer');
    if (container) {
        container.style.display = 'none';
    }
    // Limpar slots gerados
    generatedSlots = [];
    showMessage('Slots discarded. Generate again when ready.', 'info');
}

function confirmSlotsPreview() {
    const container = document.getElementById('slotsPreviewContainer');
    if (container) {
        container.style.display = 'none';
    }
    showMessage('‚úÖ Slots confirmed! Now save your configuration to activate them.', 'success');
}

window.onload = () => {
    // Check authentication first
    checkAuth();
    
    const savedLang = localStorage.getItem('slotly_lang');
        if (savedLang && ['en', 'pt', 'es', 'fr', 'de', 'it'].includes(savedLang)) {
        currentLanguage = savedLang;
        document.getElementById('languageSelector').value = savedLang;
    }
    applyTranslations();
    
    // Load existing doctor data if any
    loadExistingDoctorData();
};

// Authentication functions
let currentCustomerId = null;

function checkAuth() {
    const loggedIn = localStorage.getItem('slotlycare_logged_in');
    const customerId = localStorage.getItem('slotlycare_customer_id');
    
    if (loggedIn !== 'true' || !customerId) {
        // Not logged in, redirect to login
        window.location.href = 'login.html';
        return;
    }
    
    currentCustomerId = customerId;
    
    // Hide auth overlay
    document.getElementById('authOverlay').classList.add('hidden');
}

async function loadExistingDoctorData() {
    const customerId = localStorage.getItem('slotlycare_customer_id');
    if (!customerId) return;
    
    let doctorHasLink = false;
    let doctorHasName = false;
    
    try {
        // Try to find doctor by customer_id
        const response = await fetch(`https://slotlycare-backend.vercel.app/api/get-doctor-by-customer?customer_id=${customerId}`);
        const data = await response.json();
        
        if (data.success && data.doctor) {
            const doctor = data.doctor;
            
            // Check trial status
            if (customerId.startsWith('trial_')) {
                const banner = document.getElementById('trialBanner');
                banner.style.display = 'block';
                
                if (data.trial_expired) {
                    // Trial expired
                    banner.classList.add('expired');
                    document.getElementById('trialBannerTitle').innerHTML = 'üö´ Trial Expired';
                    document.getElementById('trialBannerMsg').textContent = 'Your booking link is inactive and slot generation is disabled. Subscribe to reactivate everything.';
                    
                    // Disable Generate Slots
                    const btnGenerate = document.getElementById('btnProcessSchedule');
                    btnGenerate.disabled = true;
                    btnGenerate.style.opacity = '0.5';
                    btnGenerate.style.cursor = 'not-allowed';
                    btnGenerate.textContent = 'Trial Expired ‚Äî Subscribe to Generate Slots';
                    
                    // Disable schedule input
                    document.getElementById('scheduleInput').disabled = true;
                    document.getElementById('scheduleInput').placeholder = 'Slot generation disabled ‚Äî trial expired';
                    
                    // Show overlay on preview
                    const overlay = document.getElementById('previewExpiredOverlay');
                    overlay.style.display = 'flex';
                    
                    // Disable copy button
                    const btnCopy = document.querySelector('.btn-copy');
                    if (btnCopy) {
                        btnCopy.disabled = true;
                        btnCopy.style.opacity = '0.5';
                    }
                } else {
                    // Trial active
                    const days = data.trial_days_remaining || 0;
                    document.getElementById('trialDaysText').textContent = days + (days === 1 ? ' day remaining' : ' days remaining');
                }
            }
            
            // Fill in the form with existing data
            document.getElementById('doctorName').value = doctor.name || '';
            document.getElementById('specialty').value = doctor.specialty || '';
            document.getElementById('address').value = doctor.address || '';
            document.getElementById('phone').value = doctor.phone || '';
            document.getElementById('email').value = doctor.email || '';
            document.getElementById('welcomeMsg').value = doctor.welcome_message || '';
            document.getElementById('additionalInfo').value = doctor.additional_info || '';
            document.getElementById('customLink').value = doctor.link || '';
            
            doctorHasLink = !!doctor.link;
            doctorHasName = !!doctor.name;
            
            // Set color
            if (doctor.color) {
                currentPrimaryColor = doctor.color;
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.color === doctor.color) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            // Set logo
            if (doctor.logo_url && doctor.logo_url.startsWith('data:image')) {
                document.getElementById('previewLogo').src = doctor.logo_url;
                document.getElementById('previewLogo').classList.add('active');
                document.getElementById('btnRemoveLogo').style.display = 'block';
            }
            
            // Set language
            if (doctor.language) {
                currentLanguage = doctor.language;
                document.getElementById('languageSelector').value = doctor.language;
                applyTranslations();
            }
            
            // Save the link for comparison
            savedDoctorLink = doctor.link;
            
            // Update preview
            updatePreview();
            
            // Load referral stats
            loadReferralStats();
            
            // Populate referral link preview
            if (doctor.link) {
                document.getElementById('referralLinkPreviewSlug').textContent = doctor.link;
                document.getElementById('referralLinkPreview').style.display = 'block';
            }
            
            // Show the booking link if exists
            if (doctor.link) {
                const fullLink = `https://slotlycare.com/${doctor.link}`;
                document.getElementById('bookingLink').textContent = fullLink;
            }
        }
    } catch (error) {
        console.log('No existing doctor data found or error loading:', error);
    }
    
    // Check if there's a reserved slug from the landing page
    const reservedSlug = localStorage.getItem('slotlycare_reserved_slug');
    const reservedName = localStorage.getItem('slotlycare_reserved_name');
    
    // Pre-fill link if doctor doesn't have one yet
    if (!doctorHasLink && reservedSlug) {
        document.getElementById('customLink').value = reservedSlug;
        console.log('Pre-filled link from landing page:', reservedSlug);
    }
    
    // Pre-fill name if doctor doesn't have one yet
    if (!doctorHasName && reservedName) {
        document.getElementById('doctorName').value = reservedName;
        updatePreview();
        console.log('Pre-filled name from landing page:', reservedName);
    }
    
    // Clear the reserved data from localStorage (one-time use)
    if (reservedSlug || reservedName) {
        localStorage.removeItem('slotlycare_reserved_slug');
        localStorage.removeItem('slotlycare_reserved_name');
    }
}

function logout() {
    localStorage.removeItem('slotlycare_logged_in');
    localStorage.removeItem('slotlycare_customer_id');
    window.location.href = 'login.html';
}

// Fun√ß√µes do Modal de Trocar Senha
function openChangePasswordModal() {
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    document.getElementById('passwordChangeMessage').style.display = 'none';
    document.getElementById('changePasswordModal').classList.add('active');
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
}

async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const messageEl = document.getElementById('passwordChangeMessage');
    const btn = document.getElementById('btnChangePassword');
    
    // Valida√ß√µes
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        showPasswordMessage('Please fill in all fields', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showPasswordMessage('New password must be at least 6 characters', 'error');
        return;
    }
    
    if (newPassword !== confirmNewPassword) {
        showPasswordMessage('New passwords do not match', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Changing...';
    
    try {
        const customerId = localStorage.getItem('slotlycare_customer_id');
        
        const response = await fetch('https://slotlycare-backend.vercel.app/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customer_id: customerId,
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showPasswordMessage('Password changed successfully!', 'success');
            setTimeout(() => {
                closeChangePasswordModal();
            }, 1500);
        } else {
            showPasswordMessage(data.error || 'Failed to change password', 'error');
        }
    } catch (error) {
        showPasswordMessage('Connection error. Please try again.', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Change Password';
    }
}

function showPasswordMessage(text, type) {
    const messageEl = document.getElementById('passwordChangeMessage');
    messageEl.textContent = text;
    messageEl.style.display = 'block';
    messageEl.style.background = type === 'error' ? '#FEE2E2' : '#D1FAE5';
    messageEl.style.color = type === 'error' ? '#DC2626' : '#059669';
}

// === REFERRAL FUNCTIONS ===
// ==================== REFERRAL FUNCTIONS ====================

let referralRowCounter = 0;

function createReferralRowHTML(index) {
    const lang = translations[currentLanguage] || translations['en'];
    const showEmail = document.getElementById('referralEmailToggle') && document.getElementById('referralEmailToggle').checked;
    return `
    <div class="referral-row" id="referralRow${index}" style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
        <input type="text" placeholder="${lang.referral_name}" class="referral-name-input" oninput="onReferralNameInput(this, ${index})" style="flex: 1; padding: 9px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
        <input type="email" placeholder="${lang.referral_email}" class="referral-email-input" style="flex: 1; padding: 9px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; display: ${showEmail ? 'block' : 'none'};">
        ${index > 0 ? `<button onclick="removeReferralRow(${index})" style="background: none; border: none; color: #EF4444; cursor: pointer; font-size: 0.8rem; padding: 4px 8px; white-space: nowrap;" title="${lang.referral_remove_row}">‚úï</button>` : '<div style="width: 30px;"></div>'}
    </div>`;
}

function onReferralNameInput(input, index) {
    // Update live preview from the first row
    if (index === 0) {
        const slug = nameToSlug(input.value);
        const previewEl = document.getElementById('modalLinkInviteeSlug');
        previewEl.textContent = slug || '___';
        previewEl.style.color = slug ? '#059669' : '#10B981';
    }
}

function toggleEmailFields() {
    const show = document.getElementById('referralEmailToggle').checked;
    document.querySelectorAll('.referral-email-input').forEach(el => {
        el.style.display = show ? 'block' : 'none';
        if (!show) el.value = '';
    });
}

function addReferralRow() {
    referralRowCounter++;
    const container = document.getElementById('referralRows');
    container.insertAdjacentHTML('beforeend', createReferralRowHTML(referralRowCounter));
}

function removeReferralRow(index) {
    const row = document.getElementById('referralRow' + index);
    if (row) row.remove();
}

function openReferralModal() {
    // Reset to form view
    document.getElementById('referralFormView').style.display = 'block';
    document.getElementById('referralLinksView').style.display = 'none';
    document.getElementById('referralFormButtons').style.display = 'flex';
    document.getElementById('referralLinksButtons').style.display = 'none';
    document.getElementById('referralStatusMessage').style.display = 'none';
    document.getElementById('btnSendReferral').disabled = false;

    const lang = translations[currentLanguage] || translations['en'];
    document.getElementById('btnSendReferral').textContent = lang.referral_send;

    // Populate doctor slug in modal preview
    document.getElementById('modalLinkDoctorSlug').textContent = savedDoctorLink || '';
    document.getElementById('modalLinkInviteeSlug').textContent = '___';

    // Start with one empty row
    referralRowCounter = 0;
    document.getElementById('referralRows').innerHTML = createReferralRowHTML(0);

    // Reset email toggle
    document.getElementById('referralEmailToggle').checked = false;

    document.getElementById('referralModal').classList.add('active');
}

function closeReferralModal() {
    document.getElementById('referralModal').classList.remove('active');
    // Refresh stats after closing (in case new invites were created)
    loadReferralStats();
}

function resetReferralModal() {
    // Go back to form view with clean rows
    document.getElementById('referralFormView').style.display = 'block';
    document.getElementById('referralLinksView').style.display = 'none';
    document.getElementById('referralFormButtons').style.display = 'flex';
    document.getElementById('referralLinksButtons').style.display = 'none';
    document.getElementById('referralStatusMessage').style.display = 'none';
    document.getElementById('btnSendReferral').disabled = false;

    const lang = translations[currentLanguage] || translations['en'];
    document.getElementById('btnSendReferral').textContent = lang.referral_send;

    // Reset modal link preview
    document.getElementById('modalLinkInviteeSlug').textContent = '___';

    referralRowCounter = 0;
    document.getElementById('referralRows').innerHTML = createReferralRowHTML(0);

    // Reset email toggle
    document.getElementById('referralEmailToggle').checked = false;
}

function nameToSlug(name) {
    return name.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '')
        .substring(0, 40);
}

function showReferralMessage(text, type) {
    const messageEl = document.getElementById('referralStatusMessage');
    messageEl.textContent = text;
    messageEl.style.display = 'block';
    messageEl.style.background = type === 'error' ? '#FEE2E2' : '#D1FAE5';
    messageEl.style.color = type === 'error' ? '#DC2626' : '#059669';
}

async function sendBatchReferrals() {
    const lang = translations[currentLanguage] || translations['en'];
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const emailToggleOn = document.getElementById('referralEmailToggle').checked;
    
    // Collect all rows
    const rows = document.querySelectorAll('.referral-row');
    const referrals = [];
    
    for (const row of rows) {
        const name = row.querySelector('.referral-name-input').value.trim();
        const email = row.querySelector('.referral-email-input').value.trim();
        
        // Skip completely empty rows
        if (!name && !email) continue;
        
        if (!name) {
            showReferralMessage(lang.referral_error_name, 'error');
            return;
        }
        // Only validate email if toggle is on and email is filled
        if (emailToggleOn && email && !emailRegex.test(email)) {
            showReferralMessage(lang.referral_error_email, 'error');
            return;
        }
        
        referrals.push({ name, email: email || '' });
    }
    
    if (referrals.length === 0) {
        showReferralMessage(lang.referral_error_name, 'error');
        return;
    }
    
    const btn = document.getElementById('btnSendReferral');
    btn.disabled = true;
    btn.textContent = '...';

    try {
        const response = await fetch('https://slotlycare-backend.vercel.app/api/batch-referrals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                referrals: referrals,
                referrer_customer_id: localStorage.getItem('slotlycare_customer_id') || '',
                referrer_doctor_link: savedDoctorLink || '',
                language: currentLanguage
            })
        });

        const data = await response.json();

        if (response.ok && data.success && data.invites && data.invites.length > 0) {
            showInviteLinks(data.invites, lang, referrals);
        } else {
            showReferralMessage(data.error || lang.referral_error, 'error');
            btn.disabled = false;
            btn.textContent = lang.referral_send;
        }
    } catch (error) {
        showReferralMessage(lang.referral_error, 'error');
        btn.disabled = false;
        btn.textContent = lang.referral_send;
    }
}

function showInviteLinks(invites, lang, sentReferrals) {
    // Switch to links view
    document.getElementById('referralFormView').style.display = 'none';
    document.getElementById('referralLinksView').style.display = 'block';
    document.getElementById('referralFormButtons').style.display = 'none';
    document.getElementById('referralLinksButtons').style.display = 'flex';
    
    // Title
    const titleEl = document.getElementById('referralLinksTitle');
    if (invites.length === 1) {
        titleEl.textContent = lang.referral_links_title_single;
    } else {
        titleEl.textContent = invites.length + ' ' + lang.referral_links_title_plural;
    }
    
    const doctorSlug = savedDoctorLink || '';
    
    // Build email lookup from sentReferrals
    const emailMap = {};
    if (sentReferrals) {
        sentReferrals.forEach(r => { if (r.email) emailMap[r.name.toLowerCase()] = r.email; });
    }
    
    // Build links list
    const listEl = document.getElementById('referralLinksList');
    listEl.innerHTML = invites.map(inv => {
        const hasEmail = emailMap[inv.name.toLowerCase()];
        const badge = hasEmail 
            ? `<div style="font-size: 0.72rem; color: #7C3AED; margin-top: 2px;">üìß ${lang.referral_we_send || 'SlotlyCare will send'}</div>`
            : `<div style="font-size: 0.72rem; color: #6B7280; margin-top: 2px;">üìã ${lang.referral_you_send || 'Copy and share'}</div>`;
        return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E2E8F0;">
            <div style="min-width: 0; flex: 1;">
                <div style="font-weight: 600; font-size: 0.88rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${inv.name}</div>
                <div style="font-size: 0.8rem; color: #10B981; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">slotlycare.com/convite/${doctorSlug}/${inv.slug}</div>
                ${badge}
            </div>
            <button onclick="copySingleLink('${doctorSlug}', '${inv.slug}', this)" style="background: none; border: 1px solid #D1D5DB; color: var(--text-muted); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; margin-left: 8px;">üìã</button>
        </div>`;
    }).join('');
    
    // Remove last border
    const lastItem = listEl.querySelector('div:last-child');
    if (lastItem) lastItem.style.borderBottom = 'none';
}

function copySingleLink(doctorSlug, inviteSlug, btn) {
    const link = 'https://slotlycare.com/convite/' + doctorSlug + '/' + inviteSlug;
    navigator.clipboard.writeText(link).then(() => {
        const original = btn.textContent;
        btn.textContent = '‚úì';
        btn.style.color = '#10B981';
        btn.style.borderColor = '#10B981';
        setTimeout(() => { btn.textContent = original; btn.style.color = ''; btn.style.borderColor = ''; }, 2000);
    });
}

function copyAllInviteLinks() {
    const lang = translations[currentLanguage] || translations['en'];
    const linkEls = document.querySelectorAll('#referralLinksList div > div > div:nth-child(2)');
    const links = [];
    linkEls.forEach(el => {
        links.push('https://' + el.textContent.trim());
    });
    
    navigator.clipboard.writeText(links.join('\n')).then(() => {
        const btn = document.getElementById('btnCopyAll');
        const original = btn.textContent;
        btn.textContent = lang.referral_copied_all;
        setTimeout(() => { btn.textContent = original; }, 2500);
    });
}

// ==================== REFERRAL STATS ====================

async function loadReferralStats() {
    const customerId = localStorage.getItem('slotlycare_customer_id');
    if (!customerId) return;
    
    try {
        const response = await fetch(`https://slotlycare-backend.vercel.app/api/referral-stats?customer_id=${customerId}`);
        const data = await response.json();
        
        if (data.success && data.stats && data.stats.total > 0) {
            const stats = data.stats;
            const lang = translations[currentLanguage] || translations['en'];
            const panel = document.getElementById('referralStatsPanel');
            const content = document.getElementById('referralStatsContent');
            
            let html = `<div>üë• <strong>${stats.total}</strong> ${lang.referral_stats_invited}</div>`;
            html += `<div style="margin-top: 4px;"><a onclick="openReferralDetails()" style="cursor: pointer; font-size: 0.78rem; color: #059669; text-decoration: underline; font-weight: 500;">${lang.referral_see_details || 'See details'} ‚ñ∏</a></div>`;
            
            const opened = stats.clicked + stats.trial_started + stats.converted;
            if (opened > 0) {
                html += `<div>üîó <strong>${opened}</strong> ${lang.referral_stats_opened}</div>`;
            }
            if (stats.trial_started + stats.converted > 0) {
                html += `<div>üéâ <strong>${stats.trial_started + stats.converted}</strong> ${lang.referral_stats_trial}</div>`;
            }
            
            content.innerHTML = html;
            panel.style.display = 'block';
        }
    } catch (error) {
        console.log('Could not load referral stats:', error);
    }
}

// ==================== REFERRAL DETAILS ====================

const SUPABASE_URL = 'https://hyfqxuvzesbqndglzabi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5ZnF4dXZ6ZXNicW5kZ2x6YWJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTQ4NDEsImV4cCI6MjA4Mzk5MDg0MX0.Holl4gTk-2bNmHjN2nlIRHBr4-THkZVj0Ws481-PMn4';

async function openReferralDetails() {
    const doctorName = document.getElementById('doctorName').value.trim();
    if (!doctorName) return;
    
    const lang = translations[currentLanguage] || translations['en'];
    const contentEl = document.getElementById('referralListContent');
    contentEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">...</div>';
    
    document.getElementById('referralListModal').classList.add('active');
    
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/invites?referrer_name=eq.${encodeURIComponent(doctorName)}&select=invited_name,slug,status,created_at&order=created_at.desc`,
            { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const invites = await response.json();
        
        if (!invites || invites.length === 0) {
            contentEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">‚Äî</div>';
            return;
        }
        
        const doctorSlug = savedDoctorLink || '';
        const statusConfig = {
            'pending':       { icon: 'üîó', color: '#6B7280', key: 'referral_status_pending' },
            'clicked':       { icon: 'üëÄ', color: '#D97706', key: 'referral_status_clicked' },
            'trial_started': { icon: 'üéâ', color: '#7C3AED', key: 'referral_status_trial' },
            'converted':     { icon: '‚úÖ', color: '#059669', key: 'referral_status_converted' }
        };
        
        contentEl.innerHTML = invites.map(inv => {
            const sc = statusConfig[inv.status] || statusConfig['pending'];
            const statusText = lang[sc.key] || inv.status;
            const linkUrl = `slotlycare.com/convite/${doctorSlug}/${inv.slug}`;
            return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #E2E8F0;">
                <div style="min-width: 0; flex: 1;">
                    <div style="font-weight: 600; font-size: 0.88rem; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${inv.invited_name}</div>
                    <div style="font-size: 0.75rem; color: #10B981; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${linkUrl}</div>
                    <div style="font-size: 0.75rem; color: ${sc.color}; margin-top: 2px;">${sc.icon} ${statusText}</div>
                </div>
                <button onclick="copySingleLink('${doctorSlug}', '${inv.slug}', this)" style="background: none; border: 1px solid #D1D5DB; color: var(--text-muted); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; margin-left: 8px;">üìã</button>
            </div>`;
        }).join('');
        
        // Remove last border
        const lastItem = contentEl.querySelector('div:last-child');
        if (lastItem) lastItem.style.borderBottom = 'none';
        
    } catch (error) {
        console.log('Error loading referral details:', error);
        contentEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #EF4444;">Error loading details</div>';
    }
}

function closeReferralListModal() {
    document.getElementById('referralListModal').classList.remove('active');
}
</script>
</body>
</html>
